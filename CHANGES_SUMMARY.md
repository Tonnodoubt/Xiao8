# Memory 分支与主项目 (N.E.K.O) 对比总结

## 📋 概述

本文档总结了 **Memory 分支**（`Tonnodoubt/Xiao8` 的 `Memory` 分支）相对于主项目 **Project-N-E-K-O/N.E.K.O** 的主要差异和改进。

**对比基准：** `upstream/main` (主项目最新版本)  
**当前分支：** `Memory`  
**最后同步：** 2025-12-19

---

## 🎯 核心功能差异

### 1. ✨ 多语言翻译字幕功能（核心新增功能）

Memory 分支添加了完整的**实时翻译字幕系统**，这是主项目目前不具备的功能。

#### 1.1 功能特性

- **智能语言检测**：自动检测 AI 回复的语言
- **实时翻译字幕**：当 AI 使用非用户语言回复时，自动显示翻译字幕
- **多级翻译链条**：实现了多层次的翻译服务备选方案
- **用户控制**：提供字幕开关，用户可自由启用/禁用翻译字幕
- **自动隐藏**：字幕在 30 秒无新内容后自动隐藏
- **平滑过渡**：翻译结果平滑更新，避免闪烁

#### 1.2 技术实现

**后端 (`utils/language_utils.py`)**
- 新增完整的语言检测和翻译模块
- 实现多级翻译优先级链条：
  ```
  Google 翻译 → LibreTranslate → DeepL → LLM 翻译
  ```
- 支持的语言：中文 (zh)、英文 (en)、日语 (ja)
- 详细的日志记录，便于调试和监控

**前端 (`static/app.js` + `templates/index.html`)**
- 新增字幕显示区域（屏幕中下方）
- 字幕提示和开关控制（对话框底部）
- 自动语言检测和翻译请求
- 平滑的动画效果和用户体验优化

**API (`main_routers/config_router.py`)**
- 新增 `/api/config/translate` 翻译端点
- 支持前端实时翻译请求

---

## 📝 详细修改清单

### 2. 新增文件

#### 2.1 启动脚本
- **`start_servers.bat`**
  - Windows 批处理脚本
  - 自动启动 memory server 和 main server
  - 自动打开浏览器

### 3. 修改的文件

#### 3.1 核心翻译模块 (`utils/language_utils.py`)

**新增功能：**
- ✅ 语言检测函数 `detect_language()`
  - 支持中文、英文、日语检测
  - 使用正则表达式识别字符类型
  - 智能判断混合语言文本

- ✅ 多级翻译链条 `translate_text()`
  - **优先级 1：Google 翻译** (`googletrans` 库)
    - 免费，但可能需要梯子
    - 支持长文本自动分段（15k 字符限制）
  - **优先级 2：LibreTranslate**
    - 开源，免费，不需要 API key
    - 多个公共实例端点备选
  - **优先级 3：DeepL 翻译**
    - 免费版每月 50 万字符
    - 需要 API key（可配置）
    - 不需要梯子
  - **优先级 4：LLM 翻译（回退方案）**
    - 使用 correction 模型
    - 保证翻译服务始终可用

- ✅ 翻译服务实现
  - `translate_with_libretranslate()` - LibreTranslate API 实现
  - `translate_with_deepl()` - DeepL API 实现
  - 详细的错误处理和日志记录

- ✅ 用户语言获取
  - `get_user_language_async()` - 异步获取用户语言偏好
  - 支持 Steam 语言检测

**改进：**
- 详细的日志输出（INFO/WARNING 级别）
- 完善的错误处理机制
- 支持异步 HTTP 请求（`aiohttp`）

#### 3.2 前端应用逻辑 (`static/app.js`)

**新增功能：**
- ✅ 字幕显示系统
  - `translateAndShowSubtitle()` - 翻译并显示字幕
  - `showSubtitlePrompt()` - 显示字幕提示和开关
  - `hideSubtitlePrompt()` - 隐藏字幕提示
  - `getSubtitleEnabled()` / `setSubtitleEnabled()` - 字幕开关状态管理

- ✅ 智能语言检测
  - 自动检测 AI 回复语言
  - 仅在语言不同时显示翻译字幕
  - 语言相同时自动隐藏提示和字幕

- ✅ 用户体验优化
  - 字幕 30 秒自动隐藏
  - 翻译结果平滑更新（避免闪烁）
  - 防止旧翻译结果覆盖新结果

**修改：**
- `socket.onmessage` 处理 `turn end` 事件时调用翻译
- 移除流式翻译，改为回合结束后统一翻译

#### 3.3 前端模板 (`templates/index.html`)

**新增 UI 元素：**
- ✅ 字幕显示区域 (`#subtitle-display`)
  - 位置：屏幕中下方
  - 样式：蓝色渐变背景，圆角，阴影效果
  - 动画：淡入淡出效果

- ✅ 字幕提示框 (`.subtitle-prompt-message`)
  - 位置：对话框底部
  - 内容：翻译字幕开关提示
  - 样式：扁平化设计，与系统风格统一

- ✅ 字幕开关控件
  - 圆形点击式开关
  - 支持 i18n 国际化
  - 响应式设计

**样式改进：**
- 字幕区域 CSS 动画
- 响应式布局优化
- 移动端适配

#### 3.4 API 路由 (`main_routers/config_router.py`)

**新增端点：**
- ✅ `POST /api/config/translate`
  - 接收前端翻译请求
  - 自动检测源语言
  - 调用翻译服务
  - 返回翻译结果和语言信息

**修改：**
- 添加翻译请求日志记录
- 支持 DeepL API key 配置（`deeplApiKey`）

#### 3.5 国际化 (`static/locales/`)

**新增翻译键：**
- `subtitle.enable` - "开启字幕" / "Enable Subtitles"
  - 中文：`zh-CN.json`
  - 英文：`en.json`

#### 3.6 依赖管理 (`pyproject.toml`)

**新增依赖：**
- `googletrans>=4.0.0` - Google 翻译库
- `aiohttp>=3.8.0` - 异步 HTTP 客户端

---

## 🔧 技术改进

### 4. 代码质量提升

#### 4.1 错误处理
- 完善的异常捕获和处理
- 详细的错误日志记录
- 优雅的降级策略（翻译服务失败时回退到 LLM）

#### 4.2 日志系统
- 统一的日志格式
- 清晰的日志级别（INFO/WARNING/DEBUG）
- 翻译服务使用情况追踪

#### 4.3 性能优化
- 异步 HTTP 请求（`aiohttp`）
- 防止重复翻译请求
- 智能缓存翻译结果

---

## 📊 统计数据

### 5. 代码变更统计

**新增代码：**
- `utils/language_utils.py`: ~470 行（全新文件）
- `static/app.js`: ~150 行（字幕相关功能）
- `templates/index.html`: ~100 行（字幕 UI）
- `main_routers/config_router.py`: ~50 行（翻译 API）
- `start_servers.bat`: ~20 行（启动脚本）

**修改代码：**
- 多个文件的局部修改和优化

**总计：** 约 **790+ 行**新增/修改代码

### 6. 提交历史

Memory 分支独有的主要提交：

1. `ee494dd` - 改进翻译服务：添加详细日志和错误处理，优化 LibreTranslate 支持
2. `aad1136` - 实现多级翻译链条和字幕功能优化
3. `1e96731` - 添加翻译字幕功能
4. 其他合并和优化提交

---

## 🎨 UI/UX 改进

### 7. 用户界面增强

#### 7.1 字幕显示
- **位置**：屏幕中下方，不遮挡主要内容
- **样式**：蓝色渐变背景，与系统风格统一
- **动画**：平滑的淡入淡出效果
- **响应式**：支持移动端和桌面端

#### 7.2 字幕控制
- **提示框**：简洁的提示信息
- **开关**：圆形点击式，符合系统设计语言
- **国际化**：支持多语言界面

---

## 🔄 与主项目的兼容性

### 8. 向后兼容性

✅ **完全兼容**
- 所有新增功能都是**可选功能**
- 不影响现有功能的使用
- 字幕功能默认关闭，需要用户手动启用
- 翻译服务失败时自动回退，不影响主流程

### 9. 可合并性

✅ **易于合并**
- 代码结构清晰，模块化设计
- 新增功能独立，不影响核心逻辑
- 遵循主项目的代码风格和规范

---

## 🚀 未来计划

### 10. 潜在改进方向

1. **翻译质量优化**
   - 支持更多翻译服务
   - 翻译结果缓存机制
   - 用户反馈和评分系统

2. **功能扩展**
   - 支持更多语言
   - 字幕样式自定义
   - 翻译历史记录

3. **性能优化**
   - 翻译请求去重
   - 批量翻译支持
   - 客户端缓存

---

## 📚 相关文档

### 11. 参考链接

- **主项目仓库：** https://github.com/Project-N-E-K-O/N.E.K.O
- **当前分支仓库：** https://github.com/Tonnodoubt/Xiao8
- **LibreTranslate：** https://github.com/LibreTranslate/LibreTranslate
- **DeepL API：** https://www.deepl.com/docs-api

---

## 📝 总结

Memory 分支在保持与主项目完全兼容的基础上，新增了**完整的实时翻译字幕系统**，这是一个**用户友好的多语言支持功能**。主要特点：

✅ **功能完整**：从语言检测到翻译显示，完整的实现  
✅ **用户体验优秀**：智能检测、平滑动画、用户控制  
✅ **技术可靠**：多级备选方案，确保服务可用性  
✅ **易于维护**：代码清晰，日志完善，便于调试  

这个功能特别适合**多语言用户**和**国际化场景**，能够显著提升非母语用户的使用体验。

---

**文档生成时间：** 2025-12-19  
**维护者：** Memory 分支开发团队

