<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="live2d.manager">æ¨¡å‹ç®¡ç†å™¨ - Project N.E.K.O.</title>
    <!-- i18next åŠ è½½å™¨ï¼ˆç»Ÿä¸€å¤„ç† CDN åŠ è½½å’Œåˆå§‹åŒ–ï¼‰ -->
    <script src="/static/i18n-i18next.js"></script>
    <script src="/static/common_dialogs.js"></script>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #eee;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
        }

        #live2d-container {
            position: fixed;
            right: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
        }

        #live2d-canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: grab;
            pointer-events: auto;
        }

        #live2d-canvas:active {
            cursor: grabbing;
        }

        #vrm-container {
            position: fixed;
            right: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
        }

        #sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            width: 300px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 40px);
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }

        .control-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .control-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            cursor: pointer;
            background: #fff;
            color: #333;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23d5f1ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

        .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: white;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-primary {
            background: #44b7fe;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2662c8;
        }

        .btn-secondary {
            background: #d5f1ff;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #b8e5ff;
            color: #333;
        }

        .btn-success {
            background: #44b7fe;
        }

        .btn-success:hover:not(:disabled) {
            background: #2662c8;
        }

        #save-position-btn {
            background: #d5f1ff !important;
            color: #333 !important;
        }

        #save-position-btn:hover:not(:disabled) {
            background: #b8e5ff !important;
            color: #333 !important;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-icon img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .action-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-group .control-select {
            flex-grow: 1;
            min-width: 200px;
        }
        
        .action-group .btn-icon {
            flex-shrink: 0;
            white-space: nowrap;
        }
        /* é”å®šæ—¶æ‰‹åŠ¿ */
        .vrm-locked {
            cursor: default !important;
        }
        /* é»˜è®¤æŠ“å–æ‰‹åŠ¿ */
        #vrm-canvas {
            cursor: grab !important;
        }

        /* æ‹–æ‹½ä¸­æ‰‹åŠ¿ */
        #vrm-canvas:active, .vrm-dragging {
            cursor: grabbing !important;
        }

        #persistent-list {
            margin-top: 6px;
            max-height: 120px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 6px;
            background: #fff;
        }

        /* æ‰“å…‰æ§åˆ¶æ ·å¼ */
        .lighting-control {
            margin-bottom: 12px;
        }

        .lighting-control label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 6px;
        }

        .lighting-control input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
        }

        .lighting-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #44b7fe;
            border-radius: 50%;
            cursor: pointer;
        }

        .lighting-control input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #44b7fe;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .lighting-control span {
            font-size: 13px;
            color: #666;
            text-align: right;
        }

        #status {
            margin-top: 10px;
            color: #4f8cff;
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div class="control-group">
            <button id="backToMainBtn" class="btn btn-primary" data-i18n="live2d.backToMain">â† è¿”å›ä¸»é¡µ</button>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.importModel">å¯¼å…¥æ¨¡å‹:</label>
            <input type="file" id="model-upload" webkitdirectory directory multiple style="display: none;">
            <input type="file" id="vrm-file-upload" accept=".vrm" style="display: none;">
            <button id="upload-btn" class="btn btn-primary" data-i18n="live2d.selectFolder">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</button>
            <div id="upload-status" style="font-size:12px; color:#666; margin-top:4px;"></div>
        </div>

        <div class="control-group">
            <label for="model-type-select" class="control-label" data-i18n="live2d.modelType">æ¨¡å‹ç±»å‹:</label>
            <select id="model-type-select" class="control-select">
                <option value="live2d">Live2D</option>
                <option value="vrm">VRM</option>
            </select>
        </div>

        <div class="control-group" id="live2d-model-group">
            <label for="model-select" class="control-label" id="live2d-model-label" data-i18n="live2d.selectLive2DModel">é€‰æ‹©Live2Dæ¨¡å‹:</label>
            <select id="model-select" class="control-select">
                <option data-i18n="common.loading">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div class="control-group" id="vrm-model-group" style="display:none;">
            <label for="vrm-model-select" class="control-label" id="vrm-model-label" data-i18n="live2d.selectVRMModel">é€‰æ‹©VRMæ¨¡å‹:</label>
            <select id="vrm-model-select" class="control-select">
                <option data-i18n="common.loading">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <!-- VRMåŠ¨ä½œé¢„è§ˆ -->
        <div class="control-group" id="vrm-animation-group" style="display:none;">
            <label class="control-label" data-i18n="live2d.vrmAnimation.title">VRMåŠ¨ä½œé¢„è§ˆ:</label>
            <div class="action-group">
                <select id="vrm-animation-select" class="control-select" disabled>
                    <option value="" data-i18n="live2d.vrmAnimation.selectAnimation">é€‰æ‹©åŠ¨ä½œ</option>
                </select>
                <button id="play-vrm-animation-btn" class="btn btn-primary btn-icon" disabled>
                    <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                    <span data-i18n="live2d.play">æ’­æ”¾</span>
                </button>
                <button id="stop-vrm-animation-btn" class="btn btn-secondary btn-icon" disabled>
                    <img src="/static/icons/rest_off.png" alt="åœæ­¢æ’­æ”¾" data-i18n-alt="live2d.vrmAnimation.stop" style="width: 20px; height: 20px;">
                    <span data-i18n="live2d.vrmAnimation.stop">åœæ­¢æ’­æ”¾</span>
                </button>
            </div>
            <div style="margin-top: 8px; display: flex; align-items: center; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="vrm-animation-loop" checked style="cursor: pointer;">
                    <span data-i18n="live2d.vrmAnimation.loop">å¾ªç¯æ’­æ”¾</span>
                </label>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <span data-i18n="live2d.vrmAnimation.speed">é€Ÿåº¦:</span>
                    <input type="range" id="vrm-animation-speed" min="0.1" max="2" step="0.1" value="1.0" style="width: 80px;">
                    <span id="vrm-animation-speed-value">1.0x</span>
                </div>
            </div>
        </div>
        <div class="control-group" id="vrm-expression-group" style="display:none;">
            <label class="control-label">VRMè¡¨æƒ…é…ç½®:</label>
            <div class="action-group">
                <select id="vrm-expression-select" class="control-select" disabled>
                    <option value="">åŠ è½½æ¨¡å‹åå¯è§</option>
                </select>
                <button id="trigger-vrm-expression-btn" class="btn btn-primary btn-icon" disabled>
                    <img src="/static/icons/play_icon.png" alt="æ’­æ”¾">
                    <span>æ’­æ”¾</span>
                </button>
                <button id="reset-vrm-expression-btn" class="btn btn-secondary" disabled>
                    <span data-i18n="common.reset">æ¢å¤è‡ªåŠ¨</span>
                    <span data-i18n="common.reset">é‡ç½®è¡¨æƒ…</span>
                </button>
            </div>
        </div>


        <div class="control-group">
            <label class="control-label" data-i18n="live2d.motionPreview">åŠ¨ä½œé¢„è§ˆ:</label>
            <div class="action-group">
                <select id="motion-select" class="control-select" disabled>
                    <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
                </select>
                <button id="play-motion-btn" class="btn btn-primary btn-icon" disabled>
                    <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                    <span data-i18n="live2d.play">æ’­æ”¾</span>
                </button>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.expressionPreview">è¡¨æƒ…é¢„è§ˆ:</label>
            <div class="action-group">
                <select id="expression-select" class="control-select" disabled>
                    <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
                </select>
                <button id="play-expression-btn" class="btn btn-primary btn-icon" disabled>
                    <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                    <span data-i18n="live2d.play">æ’­æ”¾</span>
                </button>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.persistentExpression">å¸¸é©»è¡¨æƒ…ï¼ˆä»…expressionï¼‰:</label>
            <p style="font-size: 11px; color: #666; margin: 4px 0 8px 0;" data-i18n="live2d.persistentHint">
                å¸¸é©»è¡¨æƒ…ä¼šä¸€ç›´ç”Ÿæ•ˆï¼Œä¸ä¼šè¢«æ¸…é™¤æˆ–è¦†ç›–ï¼›æ­¤å¤„ä»…èƒ½é€‰æ‹© .exp3.jsonã€‚
            </p>
            <select id="persistent-expression-select" class="control-select" disabled>
                <option value="" data-i18n="live2d.selectPersistentExpression">é€‰æ‹©å¸¸é©»è¡¨æƒ…</option>
            </select>
            <div id="persistent-list" style="display: none;"></div>
        </div>

        <div class="control-group" id="emotion-manager-group">
            <div style="display:flex; gap: 10px;">
                <button id="emotion-manager-btn" class="btn btn-primary btn-icon" disabled style="flex:1;">
                    <img src="/static/icons/emotion_config_icon.png" alt="æƒ…æ„Ÿé…ç½®" data-i18n-alt="live2d.emotionConfig">
                    <span data-i18n="live2d.emotionConfig">æƒ…æ„Ÿé…ç½®</span>
                </button>
            </div>
        </div>

        <!-- VRM æ‰“å…‰è®¾ç½® -->
        <div class="control-group" id="vrm-lighting-group" style="display:none;">
            <label class="control-label">ğŸ’¡ VRMæ‰“å…‰è®¾ç½®:</label>

            <div class="lighting-control">
                <label for="ambient-light-slider">ç¯å¢ƒå…‰å¼ºåº¦:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="ambient-light-slider" min="0" max="0.3" step="0.01" value="0.08" style="flex: 1;">
                    <span id="ambient-light-value" style="min-width: 40px;">0.08</span>
                </div>
            </div>

            <div class="lighting-control">
                <label for="main-light-slider">ä¸»å…‰æºå¼ºåº¦:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="main-light-slider" min="0" max="2.5" step="0.01" value="0.06" style="flex: 1;">
                    <span id="main-light-value" style="min-width: 40px;">0.06</span>
                </div>
            </div>

            <div class="lighting-control">
                <label for="fill-light-slider">è¡¥å…‰å¼ºåº¦:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="fill-light-slider" min="0" max="0.5" step="0.01" value="0.12" style="flex: 1;">
                    <span id="fill-light-value" style="min-width: 40px;">0.12</span>
                </div>
            </div>

            <div class="lighting-control">
                <label for="rim-light-slider">è½®å»“å…‰å¼ºåº¦:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="rim-light-slider" min="0" max="1.5" step="0.05" value="0.8" style="flex: 1;">
                    <span id="rim-light-value" style="min-width: 40px;">0.8</span>
                </div>
            </div>


            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="reset-lighting-btn" class="btn btn-secondary" style="flex: 1;">
                    <span>ğŸ”„ é‡ç½®é»˜è®¤</span>
                </button>
            </div>
        </div>

        <div class="control-group" id="save-settings-group">
            <div style="display:flex; gap: 10px;">
                <button id="save-position-btn" class="btn btn-success btn-icon" disabled style="flex:1;">
                    <img src="/static/icons/save_settings.png" alt="ä¿å­˜è®¾ç½®" data-i18n-alt="live2d.saveSettings">
                    <span data-i18n="live2d.saveSettings">ä¿å­˜è®¾ç½®</span>
                </button>
            </div>
        </div>

        <div class="control-group" id="parameter-editor-group">
            <a href="/live2d_parameter_editor" class="btn btn-secondary"
                style="width:100%; text-decoration: none; display: block; text-align: center;"
                data-i18n="live2d.parameterEditor.title">
                <span>ğŸ¨ å‚æ•°ç¼–è¾‘å™¨</span>
            </a>
        </div>


        <div id="status" data-i18n="status.initializing">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="vrm-container" class="hidden"></div>

    <script src="/static/libs/live2dcubismcore.min.js"></script>
    <script src="/static/libs/live2d.min.js"></script>
    <script src="/static/libs/pixi.min.js"></script>
    <script src="/static/libs/index.min.js"></script>
    <script src="/static/live2d-core.js"></script>
    <script src="/static/live2d-emotion.js"></script>
    <script src="/static/live2d-model.js"></script>
    <script src="/static/live2d-interaction.js"></script>
    <script src="/static/live2d-ui-buttons.js"></script>
    <script src="/static/live2d-ui-popup.js"></script>
    <script src="/static/live2d-ui-hud.js"></script>
    <script src="/static/live2d-ui-drag.js"></script>
    <script src="/static/live2d-init.js"></script>
    <!-- Three.js æ ¸å¿ƒåº“å’Œimportmapï¼ˆç”¨äºES6æ¨¡å—å¯¼å…¥ï¼‰-->
    <script type="importmap">
    {
        "imports": {
            "three": "/static/libs/three.module.js",
            "three/addons/": "/static/libs/three/addons/",
            "@pixiv/three-vrm": "/static/libs/three-vrm.module.min.js"
        }
    }
    </script>
    <!-- å°† THREE æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œä»¥ä¾¿éæ¨¡å—è„šæœ¬å¯ä»¥ä½¿ç”¨ -->
    <script type="module">
        import * as THREE from 'three';
        window.THREE = THREE;
        console.log('[Three.js] ES æ¨¡å—å·²åŠ è½½');
        // å‘é€è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–è„šæœ¬ THREE å·²å°±ç»ª
        window.dispatchEvent(new CustomEvent('three-ready'));
    </script>
    <!-- VRMæ¨¡å—ï¼ˆæŒ‰é¡ºåºåŠ è½½ï¼Œå¤±è´¥ä¸å½±å“Live2Dï¼‰-->
    <script>
        (async function initVRMModules() {
        const loadModules = async () => {
            console.log('[VRM] å¼€å§‹åŠ è½½ä¾èµ–æ¨¡å—');
            const vrmModules = [
                '/static/vrm-core.js',
                '/static/vrm-expression.js',
                '/static/vrm-animation.js',
                '/static/vrm-interaction.js',
                '/static/vrm-manager.js',
                '/static/vrm-ui-popup.js',
                '/static/vrm-ui-buttons.js',
                 '/static/vrm-init.js'
            ];

            for (const moduleSrc of vrmModules) {
                const script = document.createElement('script');
                script.src = `${moduleSrc}?v=${Date.now()}`;
                await new Promise((resolve) => {
                    script.onload = resolve;
                    script.onerror = resolve; // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œé˜²æ­¢æ­»é”
                    document.body.appendChild(script);
                });
            }
            window.vrmModuleLoaded = true;
            window.dispatchEvent(new CustomEvent('vrm-modules-ready'));
        };

        // å¦‚æœ THREE è¿˜æ²¡å¥½ï¼Œå°±ç­‰äº‹ä»¶ï¼›å¥½äº†å°±ç›´æ¥åŠ è½½
        if (typeof window.THREE === 'undefined') {
            window.addEventListener('three-ready', loadModules, { once: true });
        } else {
            loadModules();
        }
    })();
    </script>

    <script>
        // ==================== ã€çº¯å‡€ç‰ˆï¼šåªä¿®æœå‘ï¼Œä¸åŠ¨éª¨éª¼ã€‘ ====================
        function fixVRMModel() {
            console.log("ğŸ”§ [æ¨¡å‹æ£€æŸ¥] æ­£åœ¨è¿è¡Œ...");

            const mgr = window.vrmManager;
            if (!mgr) return;

            // 1. è·å– VRM å®ä¾‹
            const wrapper = mgr.currentModel;
            if (!wrapper) return;
            const vrm = wrapper.vrm || wrapper;

            if (!vrm.humanoid || !vrm.scene) {
                console.warn("âš ï¸ [æ¨¡å‹æ£€æŸ¥] éæ ‡å‡† VRMï¼Œè·³è¿‡ã€‚");
                return;
            }

            // ã€é‡è¦æ”¹åŠ¨ã€‘åˆ é™¤äº†ä¹‹å‰çš„ resetPose ä»£ç 
            // å› ä¸ºæ¨¡å‹åŠ è½½é»˜è®¤å°±æ˜¯ T-Poseï¼Œå¼ºåˆ¶é‡ç½®åè€Œä¼šå¯¼è‡´æ‰‹ä¸¾é«˜ï¼ˆSurrender Poseï¼‰
            console.log("âœ… [éª¨éª¼æ£€æŸ¥] ä¿æŒé»˜è®¤å§¿æ€ (Trust Original Pose)");

            // 2. æœå‘ä¿®æ­£é€»è¾‘ (è¿™ä¸ªæ˜¯å®‰å…¨çš„ï¼Œä¿ç•™)
            try {
                const scene = vrm.scene;
                const humanoid = vrm.humanoid;

                scene.updateMatrixWorld(true);
                const foot = humanoid.getNormalizedBoneNode('leftFoot');
                const toes = humanoid.getNormalizedBoneNode('leftToes');

                if (foot && toes) {
                    const footPos = new THREE.Vector3();
                    const toesPos = new THREE.Vector3();
                    foot.getWorldPosition(footPos);
                    toes.getWorldPosition(toesPos);

                    // å¦‚æœè„šå°– Z < è„šè·Ÿ Zï¼Œè¯´æ˜èƒŒå¯¹å±å¹•
                    if (toesPos.z < footPos.z - 0.001) {
                        console.log("ğŸ”„ [æœå‘ä¿®æ­£] æ£€æµ‹åˆ°èƒŒå¯¹å±å¹• -> æ—‹è½¬ 180 åº¦");
                        scene.rotation.y = Math.PI;
                    } else {
                        console.log("âœ¨ [æœå‘æ£€æµ‹] æœå‘æ­£ç¡® -> ä¿æŒåŸæ ·");
                        scene.rotation.y = 0;
                    }
                }
            } catch (e) {
                console.error("âŒ [æ£€æŸ¥å‡ºé”™]", e);
            }
        }
        // ====================================================================
        // ç”¨äºé¡µé¢é—´é€šä¿¡çš„äº‹ä»¶å¤„ç†
        function sendMessageToMainPage(action) {
            try {
                const message = {
                    action: action,
                    timestamp: Date.now()
                };
                
                // æ–¹å¼1: å¦‚æœæ˜¯åœ¨å¼¹å‡ºçª—å£ä¸­ï¼Œä½¿ç”¨ postMessageï¼ˆæ›´å¯é ï¼‰
                if (window.opener && !window.opener.closed) {
                    console.log(`[æ¶ˆæ¯å‘é€] ä½¿ç”¨ postMessage å‘é€æ¶ˆæ¯: ${action}`);
                    window.opener.postMessage(message, window.location.origin);
                }
                
                // æ–¹å¼2: ä½¿ç”¨localStorageäº‹ä»¶æœºåˆ¶å‘é€æ¶ˆæ¯ç»™ä¸»é¡µé¢ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                try {
                    localStorage.setItem('nekopage_message', JSON.stringify(message));
                    localStorage.removeItem('nekopage_message'); // ç«‹å³ç§»é™¤ä»¥å…è®¸é‡å¤å‘é€ç›¸åŒæ¶ˆæ¯
                    console.log(`[æ¶ˆæ¯å‘é€] ä½¿ç”¨ localStorage å‘é€æ¶ˆæ¯: ${action}`);
                } catch (e) {
                    console.warn('localStorage æ¶ˆæ¯å‘é€å¤±è´¥:', e);
                }
            } catch (e) {
                console.error('å‘é€æ¶ˆæ¯ç»™ä¸»é¡µé¢å¤±è´¥:', e);
            }
        }
        
    
        
        // å…¨å±€å˜é‡ï¼šè·Ÿè¸ªæœªä¿å­˜çš„æ›´æ”¹
        window.hasUnsavedChanges = false;
        // ç»Ÿä¸€è·¯å¾„å¤„ç†å™¨ï¼Œé˜²æ­¢å¤šå¤„ç¡¬ç¼–ç 
        // ç»Ÿä¸€è·¯å¾„å¤„ç†å™¨ï¼Œé˜²æ­¢å¤šå¤„ç¡¬ç¼–ç 
        const ModelPathHelper = {
            // å°†åç«¯è¿”å›çš„ç›¸å¯¹è·¯å¾„æˆ–æœ¬åœ°è·¯å¾„è½¬æ¢ä¸ºå‰ç«¯å¯ç”¨çš„ URL
            vrmToUrl(path, type = 'animation') {
                if (!path) return '';
                // å¦‚æœå·²ç»æ˜¯ URL æ ¼å¼ (http/https) æˆ– Web ç»å¯¹è·¯å¾„ (/)ï¼Œç›´æ¥è¿”å›
                if (path.startsWith('http') || path.startsWith('/')) return path;
                
                // ã€å…³é”®ä¿®å¤ã€‘ç»Ÿä¸€å°† Windows çš„åæ–œæ è½¬æ¢ä¸ºæ­£æ–œæ ï¼Œå¦åˆ™ includes åˆ¤æ–­ä¼šå¤±è´¥
                const normalizedPath = path.replace(/\\/g, '/');
                const filename = normalizedPath.split('/').pop();

                // 1. ä¼˜å…ˆæ£€æµ‹æ˜¯å¦æ˜¯é¡¹ç›®å†…ç½®çš„ static ç›®å½•
                if (normalizedPath.includes('static/vrm')) {
                    // ä½ çš„åŠ¨ä½œæ–‡ä»¶ç¡®å®åœ¨ animation ç›®å½•ä¸‹
                    return `/static/vrm/animation/${filename}`;
                } 
                
                // 2. æ£€æµ‹å…¶ä»–å¯èƒ½çš„ç›®å½•ç»“æ„
                else if (normalizedPath.includes('models/vrm')) {
                    return `/models/vrm/animations/${filename}`;
                }
                
                // 3. é»˜è®¤ Fallbackï¼šå¦‚æœæ˜¯åªæœ‰æ–‡ä»¶åï¼Œæˆ–è€…æ— æ³•è¯†åˆ«è·¯å¾„ï¼Œé»˜è®¤å» user_vrm æ‰¾
                return `/user_vrm/${type === 'animation' ? 'animation/' : ''}${filename}`;
            }
        };
        // ç»Ÿä¸€è¯·æ±‚å¤„ç†å™¨ï¼Œå¤„ç†å¼‚å¸¸å’Œè¶…æ—¶
        const RequestHelper = {
            async fetchJson(url, options = {}, timeout = 10000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(id);

                    // æ£€æŸ¥ HTTP çŠ¶æ€ç 
                    if (!response.ok) {
                        throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ (HTTP ${response.status})`);
                    }

                    // æ£€æŸ¥å†…å®¹ç±»å‹ï¼Œç¡®ä¿æ˜¯ JSON
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error("æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆçš„ JSON æ•°æ®");
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    clearTimeout(id);
                    if (error.name === 'AbortError') throw new Error("è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡");
                    throw error;
                }
            }
        };

        // å…¨å±æ§åˆ¶å‡½æ•°
        const requestFullscreen = () => {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                return elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                return elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                return elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                return elem.msRequestFullscreen();
            }
            return Promise.reject(new Error('Fullscreen not supported'));
        };

        const exitFullscreen = () => {
            if (document.exitFullscreen) {
                return document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                return document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                return document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                return document.msExitFullscreen();
            }
            return Promise.reject(new Error('Exit fullscreen not supported'));
        };

        const isFullscreen = () => {
            return !!(document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // æ›´æ–°i18nç¿»è¯‘
            if (window.updatePageTexts && typeof window.updatePageTexts === 'function') {
                window.updatePageTexts();
            }
            // å»¶è¿Ÿå†æ¬¡æ›´æ–°ï¼Œç¡®ä¿i18nextå®Œå…¨åˆå§‹åŒ–
            setTimeout(() => {
                if (window.updatePageTexts && typeof window.updatePageTexts === 'function') {
                    window.updatePageTexts();
                }
            }, 500);

            // Electronç™½å±ä¿®å¤
            if (document.body) {
                void document.body.offsetHeight;
                const currentOpacity = document.body.style.opacity || '1';
                document.body.style.opacity = '0.99';
                requestAnimationFrame(() => {
                    document.body.style.opacity = currentOpacity;
                });
            }

            const statusDiv = document.getElementById('status');
            const modelTypeSelect = document.getElementById('model-type-select');
            const modelSelect = document.getElementById('model-select');
            const vrmModelSelect = document.getElementById('vrm-model-select');
            const live2dModelGroup = document.getElementById('live2d-model-group');
            const vrmModelGroup = document.getElementById('vrm-model-group');
            const vrmAnimationGroup = document.getElementById('vrm-animation-group');
            const vrmExpressionGroup = document.getElementById('vrm-expression-group');
            const vrmExpressionSelect = document.getElementById('vrm-expression-select');
            const triggerVrmExpressionBtn = document.getElementById('trigger-vrm-expression-btn');
            const resetVrmExpressionBtn = document.getElementById('reset-vrm-expression-btn');
            const live2dContainer = document.getElementById('live2d-container');
            const vrmContainer = document.getElementById('vrm-container');
            const motionSelect = document.getElementById('motion-select');
            const expressionSelect = document.getElementById('expression-select');
            const playMotionBtn = document.getElementById('play-motion-btn');
            const playExpressionBtn = document.getElementById('play-expression-btn');
            const emotionManagerBtn = document.getElementById('emotion-manager-btn');
            const savePositionBtn = document.getElementById('save-position-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const modelUpload = document.getElementById('model-upload');
            const vrmFileUpload = document.getElementById('vrm-file-upload');
            const uploadStatus = document.getElementById('upload-status');
            const backToMainBtn = document.getElementById('backToMainBtn');
            const vrmAnimationSelect = document.getElementById('vrm-animation-select');
            const playVrmAnimationBtn = document.getElementById('play-vrm-animation-btn');
            const stopVrmAnimationBtn = document.getElementById('stop-vrm-animation-btn');
            const vrmAnimationLoop = document.getElementById('vrm-animation-loop');
            const vrmAnimationSpeed = document.getElementById('vrm-animation-speed');
            const vrmAnimationSpeedValue = document.getElementById('vrm-animation-speed-value');


            // æ£€æµ‹é¡µé¢æ¥æºï¼Œè®¾ç½®è¿”å›æŒ‰é’®æ–‡æœ¬
            const isPopupWindow = window.opener !== null;
            if (isPopupWindow) {
                backToMainBtn.textContent = t('common.close', 'âœ– å…³é—­');

                // å°è¯•æœ€å¤§åŒ–çª—å£
                try {
                    window.resizeTo(screen.availWidth, screen.availHeight);
                    window.moveTo(0, 0);
                } catch (e) {
                    console.log('æœ€å¤§åŒ–çª—å£å¤±è´¥:', e);
                }

                // ä¸ºpopupçª—å£æ·»åŠ å…¨å±æŒ‰é’®
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.id = 'fullscreen-btn';
                fullscreenBtn.className = 'btn btn-primary';
                fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                fullscreenBtn.setAttribute('data-i18n', 'live2d.toggleFullscreen');
                fullscreenBtn.onclick = async () => {
                    try {
                        if (isFullscreen()) {
                            await exitFullscreen();
                            fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                            fullscreenBtn.setAttribute('data-i18n', 'live2d.toggleFullscreen');
                        } else {
                            await requestFullscreen();
                            fullscreenBtn.textContent = t('live2d.exitFullscreen', 'é€€å‡ºå…¨å±');
                            fullscreenBtn.setAttribute('data-i18n', 'live2d.exitFullscreen');
                        }
                    } catch (e) {
                        console.log('åˆ‡æ¢å…¨å±å¤±è´¥:', e);
                    }
                };

                // å°†å…¨å±æŒ‰é’®æ·»åŠ åˆ°è¿”å›æŒ‰é’®æ—è¾¹
                const backToMainBtnParent = backToMainBtn.parentElement;
                backToMainBtnParent.appendChild(fullscreenBtn);
            } else {
                backToMainBtn.textContent = t('live2d.backToMain', 'â† è¿”å›ä¸»é¡µ');
            }

            // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.addEventListener('fullscreenchange', updateFullscreenButton);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
            document.addEventListener('mozfullscreenchange', updateFullscreenButton);
            document.addEventListener('MSFullscreenChange', updateFullscreenButton);

            function updateFullscreenButton() {
                const fullscreenBtn = document.getElementById('fullscreen-btn');
                if (fullscreenBtn) {
                    if (isFullscreen()) {
                        fullscreenBtn.textContent = t('live2d.exitFullscreen', 'é€€å‡ºå…¨å±');
                        fullscreenBtn.setAttribute('data-i18n', 'live2d.exitFullscreen');
                    } else {
                        fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                        fullscreenBtn.setAttribute('data-i18n', 'live2d.toggleFullscreen');
                    }
                }
            }

            // é¡µé¢åŠ è½½æ—¶å‘é€æ¶ˆæ¯éšè—ä¸»ç•Œé¢ï¼ˆä»…åœ¨å¼¹å‡ºçª—å£æ¨¡å¼ä¸‹ï¼‰
            if (isPopupWindow) {
                sendMessageToMainPage('hide_main_ui');
            }

            // ç¿»è¯‘è¾…åŠ©å‡½æ•°ï¼šç®€åŒ–ç¿»è¯‘è°ƒç”¨å¹¶å¤„ç†é”™è¯¯
            function t(key, fallback, params = {}) {
                try {
                    if (window.t && typeof window.t === 'function') {
                        return window.t(key, params);
                    }
                } catch (e) {
                    console.error(`[i18n] Translation failed for key "${key}":`, e);
                }
                return fallback;
            }

            let currentModelInfo = null;
            let availableModels = [];
            let currentModelFiles = { motion_files: [], expression_files: [] };
            let live2dModel = null;
            let currentEmotionMapping = null; // { motions: {...}, expressions: {...} }
            let currentModelType = 'live2d'; // 'live2d' or 'vrm'
            let vrmManager = null;
            let vrmAnimations = []; // VRM åŠ¨ä½œåˆ—è¡¨
            let animationsLoaded = false; // æ ‡è®°VRMåŠ¨ä½œåˆ—è¡¨æ˜¯å¦å·²åŠ è½½

            const showStatus = (msg, duration = 0) => {
                statusDiv.textContent = msg;
                if (duration > 0) {
                    setTimeout(() => {
                        if (currentModelInfo) {
                            showStatus(t('live2d.currentModel', `å½“å‰æ¨¡å‹: ${currentModelInfo.name}`, { model: currentModelInfo.name }));
                        }
                    }, duration);
                }
            };

            await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
            showStatus(t('live2d.pixiInitialized', 'PIXI åˆå§‹åŒ–å®Œæˆ'));

            // å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨
            try {
                // ä½¿ç”¨åŠ©æ‰‹æ›¿æ¢åŸæœ‰ fetch
                availableModels = await RequestHelper.fetchJson('/api/live2d/models');
                
                if (availableModels.length > 0) {
                    modelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                    availableModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.display_name || model.name;
                        option.dataset.itemId = model.item_id;
                        modelSelect.appendChild(option);
                    });
                    showStatus(t('live2d.modelListLoaded', 'æ¨¡å‹åˆ—è¡¨åŠ è½½æˆåŠŸ'));
                } else {
                    showStatus(t('live2d.noModelsFound', 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹'));
                }
            } catch (e) {
                console.error('åŠ è½½ Live2D åˆ—è¡¨å¤±è´¥:', e);
                showStatus(t('live2d.modelListLoadFailed', `åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${e.message}`));
            }

            // åˆå§‹åŒ–æ¨¡å‹ç±»å‹ï¼ˆä» localStorage æˆ–é»˜è®¤å€¼ï¼‰
            const savedModelType = localStorage.getItem('modelType') || 'live2d';
            await switchModelDisplay(savedModelType);


            // å¦‚æœå·²è‡ªåŠ¨åŠ è½½äº†ä¸€ä¸ªæ¨¡å‹ï¼Œç¡®ä¿åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰ä¸­å®ƒ
            if (currentModelInfo && currentModelInfo.name) {
                const exists = availableModels.some(m => m.name === currentModelInfo.name);
                if (exists && modelSelect.value !== currentModelInfo.name) {
                    console.log('ä¸‹æ‹‰æ¡†å€¼æœªæ­£ç¡®è®¾ç½®ï¼Œæ‰§è¡Œè¡¥æ•‘:', currentModelInfo.name);
                    modelSelect.value = currentModelInfo.name;
                }
            }

            // è·å– lanlan_name çš„è¾…åŠ©å‡½æ•°
            async function getLanlanName() {
                // ä¼˜å…ˆä» URL è·å–
                const urlParams = new URLSearchParams(window.location.search);
                let lanlanName = urlParams.get('lanlan_name') || '';

                // å¦‚æœ URL ä¸­æ²¡æœ‰ï¼Œä» API è·å–
                if (!lanlanName) {
                    try {
                        const response = await fetch('/api/config/page_config');
                        const data = await response.json();
                        if (data.success) {
                            lanlanName = data.lanlan_name || '';
                        }
                    } catch (error) {
                        console.error('è·å– lanlan_name å¤±è´¥:', error);
                    }
                }

                return lanlanName;
            }

            // åŠ¨æ€è®¾ç½®å‚æ•°ç¼–è¾‘å™¨é“¾æ¥ï¼Œä¼ é€’ lanlan_name å‚æ•°
            (async function updateParameterEditorLink() {
                try {
                    const paramEditorLink = document.querySelector('a[href="/live2d_parameter_editor"]');
                    if (paramEditorLink) {
                        const lanlanName = await getLanlanName();
                        if (lanlanName) {
                            paramEditorLink.href = `/live2d_parameter_editor?lanlan_name=${encodeURIComponent(lanlanName)}`;
                            console.log('å‚æ•°ç¼–è¾‘å™¨é“¾æ¥å·²æ›´æ–°ï¼Œè§’è‰²:', lanlanName);
                        }
                    }
                } catch (error) {
                    console.error('æ›´æ–°å‚æ•°ç¼–è¾‘å™¨é“¾æ¥å¤±è´¥:', error);
                }
            })();

            //
            // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²çš„å‡½æ•°ï¼ˆå…¨é¢å‡çº§ç‰ˆï¼‰
            async function saveModelToCharacter(modelName, itemId = null, vrmAnimation = null) {
                try {
                    // 1. è·å–è§’è‰²å
                    const lanlanName = await getLanlanName();
                    if (!lanlanName) {
                        showStatus(t('live2d.cannotSaveNoCharacter', 'æ— æ³•ä¿å­˜ï¼šæœªæŒ‡å®šè§’è‰²åç§°'));
                        return false;
                    }

                    showStatus(t('live2d.savingSettings', 'æ­£åœ¨ä¿å­˜è®¾ç½®...'));

                    // 2. ğŸ”¥ å…ˆä»æœåŠ¡å™¨æ‹‰å–å½“å‰è§’è‰²çš„å®Œæ•´æ¡£æ¡ˆï¼ˆé˜²æ­¢è¦†ç›–æ‰å…¶ä»–ä¸éœ€è¦ä¿®æ”¹çš„å±æ€§ï¼‰
                    const charRes = await fetch('/api/characters');
                    if (!charRes.ok) throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨è·å–è§’è‰²æ•°æ®');
                    
                    const allData = await charRes.json();
                    // æ‹¿åˆ°è¯¥è§’è‰²çš„æ—§æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å°±åˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡
                    const charData = allData['çŒ«å¨˜']?.[lanlanName] || {};

                    // 3. æ›´æ–°æ¨¡å‹ç›¸å…³å­—æ®µ
                    if (currentModelType === 'vrm') {
                        charData.model_type = 'vrm';
                        charData.vrm = modelName;
                        // æ¸…ç©º Live2D å­—æ®µï¼Œé¿å…æ··æ·†
                        charData.live2d = ""; 
                        if (vrmAnimation) charData.vrm_animation = vrmAnimation;

                        // ğŸ”¥ è·å–å¹¶å†™å…¥å…‰ç…§æ•°æ®
                        const ambient = document.getElementById('ambient-light-slider');
                        const main = document.getElementById('main-light-slider');
                        const fill = document.getElementById('fill-light-slider');
                        const rim = document.getElementById('rim-light-slider');

                        if (ambient && main && fill && rim) {
                            charData.lighting = {
                                ambient: parseFloat(ambient.value),
                                main: parseFloat(main.value),
                                fill: parseFloat(fill.value),
                                rim: parseFloat(rim.value)
                            };
                            // ç§»é™¤æ—§çš„é¢„è®¾å­—æ®µ
                            delete charData.lightingPreset;
                        }
                    } else {
                        // Live2D é€»è¾‘
                        charData.model_type = 'live2d';
                        charData.live2d = modelName;
                        charData.vrm = null;
                        if (itemId) charData.item_id = itemId;
                    }

                    console.log('å‡†å¤‡ä¿å­˜çš„å®Œæ•´æ•°æ®:', charData);

                    // 4. ğŸ”¥ ä½¿ç”¨ã€é€šç”¨æ›´æ–°æ¥å£ã€‘å‘é€æ•°æ®ï¼ˆè¿™ä¸ªæ¥å£æ”¯æŒä¿å­˜ä»»æ„å­—æ®µï¼‰
                    // æ³¨æ„ï¼šè¿™é‡Œæ”¹ç”¨äº† /api/characters/catgirl/{name}
                    const response = await fetch(`/api/characters/catgirl/${encodeURIComponent(lanlanName)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(charData)
                    });

                    if (!response.ok) {
                        throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        const modelDisplayName = currentModelType === 'vrm' ? `VRM: ${modelName}` : modelName;
                        showStatus(t('live2d.modelSettingsSaved', `å·²ä¿å­˜æ¨¡å‹å’Œå…‰ç…§è®¾ç½®`, { name: lanlanName }), 2000);
                        return true;
                    } else {
                        throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                    }

                } catch (error) {
                    console.error('ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥:', error);
                    showStatus(t('live2d.saveFailed', `ä¿å­˜å¤±è´¥: ${error.message}`), 3000);
                    return false;
                }
            }

            // æ¨¡å‹ç±»å‹åˆ‡æ¢å¤„ç†
            async function switchModelDisplay(type) {
                currentModelType = type;
                localStorage.setItem('modelType', type);
                if (modelTypeSelect) modelTypeSelect.value = type;

                if (type === 'live2d') {
                    if (live2dModelGroup) live2dModelGroup.style.display = 'flex';
                    if (vrmModelGroup) vrmModelGroup.style.display = 'none';
                    if (live2dContainer) live2dContainer.style.display = 'block';
                    if(vrmExpressionGroup) vrmExpressionGroup.style.display = 'none';
                    if (vrmContainer) {
                        vrmContainer.classList.add('hidden');
                        vrmContainer.style.display = 'none';
                    }
                    // æ˜¾ç¤º Live2D ç‰¹æœ‰çš„æ§ä»¶
                    document.querySelectorAll('.control-group').forEach(group => {
                        if (group.id !== 'live2d-model-group' && 
                            group.id !== 'vrm-model-group' && 
                            group.id !== 'vrm-expression-group' && 
                            group.id !== 'vrm-animation-group') {
                            group.style.display = 'flex';
                        }
                    });
                    // æ˜¾ç¤ºå‚æ•°ç¼–è¾‘å™¨æŒ‰é’®
                    const parameterEditorGroup = document.getElementById('parameter-editor-group');
                    if (parameterEditorGroup) parameterEditorGroup.style.display = 'flex';
                    // æ˜¾ç¤ºæƒ…æ„Ÿé…ç½®æŒ‰é’®ç»„ï¼ˆLive2Dæ¨¡å¼ä¸‹éœ€è¦ï¼‰
                    const emotionManagerGroup = document.getElementById('emotion-manager-group');
                    if (emotionManagerGroup) emotionManagerGroup.style.display = 'flex';
                    // ç¡®ä¿ä¿å­˜è®¾ç½®æŒ‰é’®ç»„å¯è§
                    const saveSettingsGroup = document.getElementById('save-settings-group');
                    if (saveSettingsGroup) saveSettingsGroup.style.display = 'flex';
                    
                    // æ›´æ–°ä¸Šä¼ æŒ‰é’®æç¤ºæ–‡æœ¬ï¼ˆLive2Dæ¨¡å¼ï¼‰
                    if (uploadBtn) {
                        uploadBtn.setAttribute('data-i18n', 'live2d.selectFolder');
                        uploadBtn.textContent = t('live2d.selectFolder', 'ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹');
                    }
                    // éšè—VRMæ–‡ä»¶é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºLive2Dæ–‡ä»¶å¤¹é€‰æ‹©å™¨
                    if (vrmFileUpload) vrmFileUpload.style.display = 'none';
                    if (modelUpload) modelUpload.style.display = 'none'; // ä¿æŒéšè—ï¼Œé€šè¿‡æŒ‰é’®è§¦å‘
                    
                    // éšè— VRM åŠ¨ä½œé¢„è§ˆç»„
                    if (vrmAnimationGroup) vrmAnimationGroup.style.display = 'none';
                    // éšè— VRM æ‰“å…‰è®¾ç½®ç»„
                    const vrmLightingGroup = document.getElementById('vrm-lighting-group');
                    if (vrmLightingGroup) vrmLightingGroup.style.display = 'none';

                    if (!window.live2dManager.pixi_app) {
                        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
                        showStatus(t('live2d.pixiInitialized', 'PIXI åˆå§‹åŒ–å®Œæˆ'));
                    }
                } else { // VRM
                    if (live2dModelGroup) live2dModelGroup.style.display = 'none';
                    if (vrmModelGroup) vrmModelGroup.style.display = 'flex';
                    if(vrmExpressionGroup) vrmExpressionGroup.style.display = 'flex';
                    if (live2dContainer) live2dContainer.style.display = 'none';
                    if (vrmContainer) {
                        vrmContainer.classList.remove('hidden');
                        vrmContainer.style.display = 'block';
                    }
                    // éšè— Live2D ç‰¹æœ‰çš„æ§ä»¶
                    const live2dOnlyControls = ['motion-select', 'expression-select', 'play-motion-btn', 'play-expression-btn', 'emotion-manager-btn'];
                    live2dOnlyControls.forEach(id => {
                        const elem = document.getElementById(id);
                        if (elem) {
                            const group = elem.closest('.control-group');
                            if (group) group.style.display = 'none';
                        }
                    });
                    // éšè—æƒ…æ„Ÿé…ç½®æŒ‰é’®ç»„ï¼ˆVRMæ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰
                    const emotionManagerGroup = document.getElementById('emotion-manager-group');
                    if (emotionManagerGroup) emotionManagerGroup.style.display = 'none';
                    // ç¡®ä¿ä¿å­˜è®¾ç½®æŒ‰é’®ç»„å¯è§ï¼ˆVRMæ¨¡å¼ä¸‹ä¹Ÿéœ€è¦ä¿å­˜ï¼‰
                    const saveSettingsGroup = document.getElementById('save-settings-group');
                    if (saveSettingsGroup) saveSettingsGroup.style.display = 'flex';
                    // æ˜¾ç¤º VRM åŠ¨ä½œé¢„è§ˆç»„
                    if (vrmAnimationGroup) vrmAnimationGroup.style.display = 'flex';
                    // æ˜¾ç¤º VRM æ‰“å…‰è®¾ç½®ç»„
                    const vrmLightingGroup = document.getElementById('vrm-lighting-group');
                    if (vrmLightingGroup) vrmLightingGroup.style.display = 'flex';
                    // æ›´æ–°ä¸Šä¼ æŒ‰é’®æç¤ºæ–‡æœ¬ï¼ˆVRMæ¨¡å¼ï¼‰
                    if (uploadBtn) {
                        uploadBtn.setAttribute('data-i18n', 'live2d.selectVRMFile');
                        uploadBtn.textContent = t('live2d.selectVRMFile', 'ğŸ“ é€‰æ‹©VRMæ–‡ä»¶');
                    }
                    // VRMåŠ¨ä½œå·²æ”¹ä¸ºè‡ªåŠ¨å¾ªç¯æ’­æ”¾ï¼Œä¸å†éœ€è¦æ‰‹åŠ¨åŠ è½½åŠ¨ä½œåˆ—è¡¨
                    // éšè—å‚æ•°ç¼–è¾‘å™¨æŒ‰é’®ï¼ˆVRM æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰
                    const parameterEditorGroup = document.getElementById('parameter-editor-group');
                    if (parameterEditorGroup) parameterEditorGroup.style.display = 'none';
                    
                    // åˆå§‹åŒ– VRM ç®¡ç†å™¨
                    if (!vrmManager) {
                        try {
                            // 1. å®šä¹‰ä¸€ä¸ªçº¯å‡€çš„ç­‰å¾…å‡½æ•°
                            const waitForVRM = () => new Promise(resolve => {
                                if (window.VRMManager) return resolve(); // å¦‚æœå·²ç»å¥½äº†ï¼Œç›´æ¥é€šè¿‡
                                // å¦åˆ™ï¼Œç›‘å¬æˆ‘ä»¬åœ¨ 3.1 æ­¥éª¤ä¸­å®šä¹‰çš„è‡ªå®šä¹‰äº‹ä»¶
                                window.addEventListener('vrm-modules-ready', resolve, { once: true });
                                // 5ç§’ä¿åº•è¶…æ—¶ï¼Œé˜²æ­¢è„šæœ¬åŠ è½½å¤±è´¥å¯¼è‡´é¡µé¢æ°¸ä¹…å¡æ­»
                                setTimeout(resolve, 5000);
                            });

                            showStatus(t('live2d.waitingVRMLoader', 'æ­£åœ¨åˆå§‹åŒ– VRM ç®¡ç†å™¨...'));
                            
                            // 2. æ‰§è¡Œç­‰å¾…
                            await waitForVRM();

                            // 3. æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
                            if (typeof window.VRMManager === 'undefined') {
                                throw new Error('VRM æ¨¡å—åŠ è½½è¶…æ—¶æˆ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå¹¶åˆ·æ–°ã€‚');
                            }

                            // 4. åˆ›å»ºæˆ–å¤ç”¨å®ä¾‹
                            vrmManager = window.vrmManager || new window.VRMManager();
                            window.vrmManager = vrmManager;

                            // 5. ç¡®ä¿å®¹å™¨å†…æœ‰ Canvas
                            const container = document.getElementById('vrm-container');
                            if (container && !container.querySelector('canvas')) {
                                const canvas = document.createElement('canvas');
                                canvas.id = 'vrm-canvas';
                                container.appendChild(canvas);
                            }

                            // 6. åˆå§‹åŒ– Three.js åœºæ™¯
                            if (!vrmManager._isInitialized && (!vrmManager.scene || !vrmManager.camera || !vrmManager.renderer)) {
                                await vrmManager.initThreeJS('vrm-canvas', 'vrm-container');
                            }

                            showStatus(t('live2d.vrmInitialized', 'VRM ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ'));
                        } catch (error) {
                            console.error('VRM åˆå§‹åŒ–å¤±è´¥:', error);
                            showStatus(t('live2d.vrmInitFailed', `VRM åˆå§‹åŒ–å¤±è´¥: ${error.message}`));
                        }
                    }
                }
            }

            // æ¨¡å‹ç±»å‹é€‰æ‹©äº‹ä»¶
            if (modelTypeSelect) {
                modelTypeSelect.addEventListener('change', async (e) => {
                    const type = e.target.value;

                    // æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€
                    const voiceStatus = await checkVoiceModeStatus();
                    if (voiceStatus.isCurrent && voiceStatus.isVoiceMode) {
                        showStatus(t('live2d.cannotChangeModelInVoiceMode', 'è¯­éŸ³æ¨¡å¼ä¸‹æ— æ³•åˆ‡æ¢æ¨¡å‹ç±»å‹ï¼Œè¯·å…ˆåœæ­¢è¯­éŸ³å¯¹è¯'), 3000);
                        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                        e.target.value = currentModelType;
                        return;
                    }

                    await switchModelDisplay(type);
                });
            }

            // åŠ è½½ VRM æ¨¡å‹åˆ—è¡¨
            async function loadVRMModels() {
                try {
                    showStatus(t('live2d.loading', 'æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...'));
                    
                    // ä½¿ç”¨åŠ©æ‰‹ä»£æ›¿ fetch
                    const data = await RequestHelper.fetchJson('/api/model/vrm/models');
                    
                    const models = (data.success && Array.isArray(data.models)) ? data.models : [];
                    if (!vrmModelSelect) return;
                    
                    if (models.length > 0) {
                        vrmModelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                        models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.url || model.path;
                            option.setAttribute('data-path', model.path);
                            option.textContent = model.name || model.filename || model.path;
                            vrmModelSelect.appendChild(option);
                        });
                        showStatus(t('live2d.vrmModelListLoaded', 'VRM æ¨¡å‹åˆ—è¡¨åŠ è½½æˆåŠŸ'), 2000);
                    } else {
                        vrmModelSelect.innerHTML = `<option value="">${t('live2d.noVRMModelsFound', 'æœªæ‰¾åˆ°å¯ç”¨ VRM æ¨¡å‹')}</option>`;
                    }
                } catch (error) {
                    console.error('åŠ è½½ VRM æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                    vrmModelSelect.innerHTML = `<option value="">${t('live2d.loadFailed', 'åŠ è½½å¤±è´¥')}</option>`;
                    showStatus(`é”™è¯¯: ${error.message}`, 5000);
                }
            }

            // VRM æ¨¡å‹é€‰æ‹©äº‹ä»¶
            if (vrmModelSelect) {
                vrmModelSelect.addEventListener('change', async (e) => {
                    const modelPath = e.target.value;
                    if (!modelPath) return;

                    // æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€
                    const voiceStatus = await checkVoiceModeStatus();
                    if (voiceStatus.isCurrent && voiceStatus.isVoiceMode) {
                        showStatus(t('live2d.cannotChangeModelInVoiceMode', 'è¯­éŸ³æ¨¡å¼ä¸‹æ— æ³•åˆ‡æ¢æ¨¡å‹ï¼Œè¯·å…ˆåœæ­¢è¯­éŸ³å¯¹è¯'), 3000);
                        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                        if (currentModelInfo && currentModelInfo.name) {
                            e.target.value = currentModelInfo.name;
                        } else {
                            e.target.value = '';
                        }
                        return;
                    }

                    // ç¡®ä¿åˆ‡æ¢åˆ°VRMæ¨¡å¼
                    if (currentModelType !== 'vrm') {
                        await switchModelDisplay('vrm');
                    }
                    
                    // ç¡®ä¿vrm-containerå¯è§
                    if (vrmContainer) {
                        vrmContainer.classList.remove('hidden');
                        vrmContainer.style.display = 'block';
                    }
                    
                    // å¦‚æœvrmManageræœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
                    if (!vrmManager) {
                        try {
                            const waitForVRM = () => new Promise(resolve => {
                                if (window.VRMManager) return resolve();
                                window.addEventListener('vrm-modules-ready', resolve, { once: true });
                                setTimeout(resolve, 5000);
                            });

                            showStatus(t('live2d.waitingVRMLoader', 'æ­£åœ¨åˆå§‹åŒ– VRM ç®¡ç†å™¨...'));
                            await waitForVRM();

                            if (typeof window.VRMManager === 'undefined') {
                                throw new Error('VRM æ¨¡å—åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                            }

                            vrmManager = window.vrmManager || new window.VRMManager();
                            window.vrmManager = vrmManager;

                            const container = document.getElementById('vrm-container');
                            if (container && !container.querySelector('canvas')) {
                                const canvas = document.createElement('canvas');
                                canvas.id = 'vrm-canvas';
                                container.appendChild(canvas);
                            }

                            if (!vrmManager._isInitialized && (!vrmManager.scene || !vrmManager.camera || !vrmManager.renderer)) {
                                await vrmManager.initThreeJS('vrm-canvas', 'vrm-container');
                            }

                            showStatus(t('live2d.vrmInitialized', 'VRM ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ'));
                        } catch (error) {
                            console.error('VRM ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                            showStatus(t('live2d.vrmInitFailed', `VRM ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`));
                            return;
                        }
                    }

                    // è·å–é€‰ä¸­çš„optionï¼Œè·å–åŸå§‹è·¯å¾„å’Œæ–‡ä»¶å
                    const selectedOption = vrmModelSelect.options[vrmModelSelect.selectedIndex];
                    const originalPath = selectedOption ? selectedOption.getAttribute('data-path') : null;
                    const filename = selectedOption ? selectedOption.getAttribute('data-filename') : null;
                    
                    // modelPath ç°åœ¨æ˜¯ URLï¼ˆå¦‚ /user_vrm/sister1.0.vrmï¼‰ï¼Œç”¨äºåŠ è½½æ¨¡å‹
                    // originalPath æ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºä¿å­˜é…ç½®
                    const modelUrl = modelPath; // ç”¨äºåŠ è½½çš„URL
                    const modelPathForConfig = originalPath || filename || modelPath; // ç”¨äºé…ç½®çš„è·¯å¾„
                    
                    // ä¿å­˜å½“å‰ VRM æ¨¡å‹ä¿¡æ¯ï¼Œç”¨äºåç»­ä¿å­˜åˆ°è§’è‰²é…ç½®ï¼ˆåœ¨åŠ è½½å‰å°±è®¾ç½®ï¼Œè¿™æ ·å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿèƒ½ä¿å­˜ï¼‰
                    currentModelInfo = {
                        name: filename || modelPathForConfig,
                        path: modelPathForConfig,
                        url: modelUrl,
                        type: 'vrm'
                    };
                    
                    // é€‰æ‹©æ¨¡å‹åç«‹å³å¯ç”¨ä¿å­˜æŒ‰é’®ï¼ˆå³ä½¿æ¨¡å‹è¿˜æœªåŠ è½½æˆ–åŠ è½½å¤±è´¥ï¼‰
                    if (savePositionBtn) {
                        savePositionBtn.disabled = false;
                    }

                    // æ ‡è®°ä¸ºæœ‰æœªä¿å­˜æ›´æ”¹
                    window.hasUnsavedChanges = true;
                    console.log('å·²æ ‡è®°ä¸ºæœªä¿å­˜æ›´æ”¹ï¼ˆVRMæ¨¡å‹åˆ‡æ¢ï¼‰ï¼Œè¯·ç‚¹å‡» ä¿å­˜è®¾ç½® æŒä¹…åŒ–åˆ°è§’è‰²é…ç½®ã€‚');
                    
                    try {
                        showStatus(t('live2d.loadingVRMModel', `æ­£åœ¨åŠ è½½ VRM æ¨¡å‹...`));
                        
                        // ç¡®ä¿å®¹å™¨å¯è§
                        if (vrmContainer) {
                            vrmContainer.classList.remove('hidden');
                            vrmContainer.style.display = 'block';
                        }
                        // åœ¨åŠ è½½æ–°æ¨¡å‹å‰ï¼Œæ˜¾å¼åœæ­¢ä¹‹å‰çš„åŠ¨ä½œå¹¶æ¸…ç†
                        if (vrmManager.vrmaAction) {
                            vrmManager.stopVRMAAnimation();
                        }
                        
                        // ä½¿ç”¨ URL åŠ è½½æ¨¡å‹ï¼Œè€Œä¸æ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼ˆæµè§ˆå™¨ä¸å…è®¸åŠ è½½ file:// è·¯å¾„ï¼‰
                        // ä¼ å…¥ { autoPlay: false } è®©æ¨¡å‹ä¿æŒ T-Pose é™æ­¢
                        await vrmManager.loadModel(modelUrl, { autoPlay: false });
                        
                        // ã€ä¿®æ”¹ã€‘è°ƒç”¨æ™ºèƒ½æ£€æµ‹å‡½æ•°
                        fixVRMModel();
                        
                        // åœ¨è¿™é‡ŒåŠ è½½è¡¨æƒ…
                        loadVRMExpressions();
                        // åŠ è½½æ–°æ¨¡å‹æ—¶é‡ç½®åŠ¨ä½œåˆ—è¡¨çŠ¶æ€ï¼Œå…è®¸é‡æ–°åŠ è½½åŠ¨ä½œ
                        animationsLoaded = false;
                        // ä¸»åŠ¨åŠ è½½åŠ¨ä½œåˆ—è¡¨ï¼Œè§£å¼€ä¸‹æ‹‰èœå•çš„é”å®šçŠ¶æ€
                        await loadVRMAnimations();

                        // è‡ªåŠ¨åŠ è½½è§’è‰²çš„æ‰“å…‰é…ç½®
                        await loadCharacterLighting();

                        showStatus(t('live2d.vrmModelLoaded', `VRM æ¨¡å‹ ${modelPath} åŠ è½½æˆåŠŸ`, { model: modelPath }));
                    } catch (error) {
                        console.error('åŠ è½½ VRM æ¨¡å‹å¤±è´¥:', error);
                        showStatus(t('live2d.vrmModelLoadFailed', `åŠ è½½ VRM æ¨¡å‹å¤±è´¥: ${error.message}ã€‚æ‚¨ä»å¯ä»¥ä¿å­˜æ¨¡å‹è®¾ç½®ã€‚`));
                        // å³ä½¿æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•åŠ è½½åŠ¨ä½œåˆ—è¡¨ï¼ˆå¯èƒ½ç”¨æˆ·æƒ³é¢„è§ˆå…¶ä»–åŠ¨ä½œï¼‰
                        try {
                            await loadVRMAnimations(false);
                        } catch (animError) {
                            console.warn('åŠ è½½åŠ¨ä½œåˆ—è¡¨å¤±è´¥:', animError);
                        }
                    }
                });
            }

            
            // åŠ è½½ VRM åŠ¨ä½œåˆ—è¡¨
            async function loadVRMAnimations(autoPlaySaved = false) {
                try {
                    showStatus(t('live2d.vrmAnimation.loading', 'æ­£åœ¨åŠ è½½åŠ¨ä½œåˆ—è¡¨...'));
                    const data = await RequestHelper.fetchJson('/api/model/vrm/animations');
                    vrmAnimations = (data.success && data.animations) ? data.animations : [];

                    if (vrmAnimationSelect && vrmAnimations.length > 0) {
                        vrmAnimationSelect.innerHTML = `<option value="">${t('live2d.vrmAnimation.selectAnimation', 'é€‰æ‹©åŠ¨ä½œ')}</option>`;
                        vrmAnimations.forEach(anim => {
                            const option = document.createElement('option');
                            const animPath = anim.path || anim;
                            
                            // ä¾ç„¶ä½¿ç”¨ ModelPathHelper è½¬æ¢è·¯å¾„
                            const finalUrl = ModelPathHelper.vrmToUrl(animPath, 'animation');
                            
                            option.value = finalUrl; 
                            option.setAttribute('data-path', animPath);
                            option.setAttribute('data-filename', anim.name || anim.filename || finalUrl.split('/').pop());
                            option.textContent = option.getAttribute('data-filename');
                            vrmAnimationSelect.appendChild(option);
                        });
                        vrmAnimationSelect.disabled = false;
                        showStatus(t('live2d.vrmAnimation.animationListLoaded', 'åŠ¨ä½œåˆ—è¡¨åŠ è½½æˆåŠŸ'), 2000);
                    } else {
                        vrmAnimationSelect.innerHTML = `<option value="">${t('live2d.vrmAnimation.noAnimations', 'æœªæ‰¾åˆ°åŠ¨ä½œæ–‡ä»¶')}</option>`;
                    }
                } catch (error) {
                    console.error('åŠ è½½ VRM åŠ¨ä½œåˆ—è¡¨å¤±è´¥:', error);
                    if (vrmAnimationSelect) {
                        vrmAnimationSelect.innerHTML = `<option value="">${t('live2d.loadFailed', 'åŠ è½½å¤±è´¥')}</option>`;
                    }
                    showStatus(`é”™è¯¯: ${error.message}`, 5000);
                }
            }

            // VRM åŠ¨ä½œé€‰æ‹©äº‹ä»¶ - é¦–æ¬¡ç‚¹å‡»æ—¶åŠ è½½åŠ¨ä½œåˆ—è¡¨
            if (vrmAnimationSelect) {
                vrmAnimationSelect.addEventListener('focus', async () => {
                    // é¦–æ¬¡è·å¾—ç„¦ç‚¹æ—¶åŠ è½½åŠ¨ä½œåˆ—è¡¨
                    if (!animationsLoaded && currentModelType === 'vrm') {
                        animationsLoaded = true; // é˜²æ­¢é‡å¤åŠ è½½
                        try {
                            await loadVRMAnimations(false);
                        } catch (error) {
                            console.error('åŠ è½½VRMåŠ¨ä½œåˆ—è¡¨å¤±è´¥:', error);
                            animationsLoaded = false; // åŠ è½½å¤±è´¥æ—¶é‡ç½®æ ‡è®°ï¼Œå…è®¸é‡è¯•
                        }
                    }
                });

                vrmAnimationSelect.addEventListener('change', (e) => {
                    const animationPath = e.target.value;
                    if (animationPath && playVrmAnimationBtn) {
                        playVrmAnimationBtn.disabled = false;
                    } else {
                        if (playVrmAnimationBtn) playVrmAnimationBtn.disabled = true;
                        if (stopVrmAnimationBtn) stopVrmAnimationBtn.disabled = true;
                    }
                });
            }

            // æ’­æ”¾ VRM åŠ¨ä½œ
            if (playVrmAnimationBtn) {
                playVrmAnimationBtn.addEventListener('click', async () => {
                    if (!vrmManager || !vrmAnimationSelect || !vrmAnimationSelect.value) {
                        showStatus(t('live2d.vrmAnimation.selectAnimationFirst', 'è¯·å…ˆé€‰æ‹©åŠ¨ä½œ'), 2000);
                        return;
                    }

                    const selectedOption = vrmAnimationSelect.options[vrmAnimationSelect.selectedIndex];
                    const originalPath = selectedOption ? selectedOption.getAttribute('data-path') : vrmAnimationSelect.value;
                    // ä¿®å¤æ­¤å¤„ï¼šè·å–åŠ¨ä½œåç§°ç”¨äºæ˜¾ç¤º
                    const animDisplayName = selectedOption ? selectedOption.getAttribute('data-filename') : 'æœªçŸ¥åŠ¨ä½œ';

                    const finalAnimationUrl = ModelPathHelper.vrmToUrl(originalPath, 'animation');
                    const loop = vrmAnimationLoop ? vrmAnimationLoop.checked : true;
                    const speed = vrmAnimationSpeed ? parseFloat(vrmAnimationSpeed.value) : 1.0;

                    try {
                        showStatus(t('live2d.vrmAnimation.playingAnimation', `æ­£åœ¨æ’­æ”¾: ${animDisplayName}`, { name: animDisplayName }), 2000);
                        await vrmManager.playVRMAAnimation(finalAnimationUrl, {
                            loop: loop,
                            timeScale: speed
                        });
                        if (stopVrmAnimationBtn) stopVrmAnimationBtn.disabled = false;
                    } catch (error) {
                        console.error('æ’­æ”¾ VRM åŠ¨ä½œå¤±è´¥:', error);
                        showStatus(t('live2d.vrmAnimation.animationPlayFailed', `æ’­æ”¾åŠ¨ä½œå¤±è´¥: ${error.message}`));
                    }
                });
            }

            // åœæ­¢ VRM åŠ¨ä½œ
            if (stopVrmAnimationBtn) {
                stopVrmAnimationBtn.addEventListener('click', () => {
                    if (vrmManager) {
                        vrmManager.stopVRMAAnimation();
                        showStatus(t('live2d.vrmAnimation.animationStopped', 'åŠ¨ä½œå·²åœæ­¢'), 2000);
                        stopVrmAnimationBtn.disabled = true;
                    }
                });
            }

            // æ’­æ”¾é€Ÿåº¦æ»‘å—
            if (vrmAnimationSpeed && vrmAnimationSpeedValue) {
                vrmAnimationSpeed.addEventListener('input', (e) => {
                    const speed = parseFloat(e.target.value);
                    vrmAnimationSpeedValue.textContent = speed.toFixed(1) + 'x';
                    // å¦‚æœæ­£åœ¨æ’­æ”¾åŠ¨ç”»ï¼Œæ›´æ–°é€Ÿåº¦
                    if (vrmManager && vrmManager.vrmaAction) {
                        vrmManager.vrmaAction.timeScale = speed;
                    }
                });
            }
            // åŠ è½½ VRM è¡¨æƒ…åˆ—è¡¨
            function loadVRMExpressions() {
                if (!vrmExpressionSelect || !vrmManager || !vrmManager.expression) return;
                
                const expressions = vrmManager.expression.getExpressionList();
                
                vrmExpressionSelect.innerHTML = '<option value="">é€‰æ‹©è¡¨æƒ…é¢„è§ˆ</option>';
                
                if (expressions.length > 0) {
                    expressions.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        vrmExpressionSelect.appendChild(opt);
                    });
                    vrmExpressionSelect.disabled = false;
                    if (resetVrmExpressionBtn) resetVrmExpressionBtn.disabled = false;
                    // ã€æ–°å¢ã€‘å¯ç”¨æ’­æ”¾æŒ‰é’®
                    if (triggerVrmExpressionBtn) triggerVrmExpressionBtn.disabled = false;
                } else {
                    vrmExpressionSelect.innerHTML = '<option value="">æ— å¯ç”¨è¡¨æƒ…</option>';
                    vrmExpressionSelect.disabled = true;
                }
            }
            // ã€æ–°å¢ã€‘æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            if (triggerVrmExpressionBtn) {
                triggerVrmExpressionBtn.addEventListener('click', () => {
                    const name = vrmExpressionSelect.value;
                    if (!name) {
                        showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…');
                        return;
                    }
                    if (vrmManager && vrmManager.expression) {
                        // è°ƒç”¨è®¾ç½®è¡¨æƒ…çš„æ–¹æ³•
                        vrmManager.expression.setBaseExpression(name);
                        showStatus(`æ­£åœ¨æ’­æ”¾è¡¨æƒ…: ${name}`);
                    }
                });
            }

            // è¡¨æƒ…é‡ç½®äº‹ä»¶
            if (resetVrmExpressionBtn) {
                resetVrmExpressionBtn.addEventListener('click', () => {
                    if (vrmManager && vrmManager.expression) {
                        // ä¼  'neutral' ä¼šåœ¨å†…éƒ¨è§¦å‘æ¢å¤è‡ªåŠ¨æ¨¡å¼
                        vrmManager.expression.setBaseExpression('neutral');
                        vrmExpressionSelect.value = '';
                    }
                });
            }

            // VRM æ‰“å…‰æ§åˆ¶
            const ambientLightSlider = document.getElementById('ambient-light-slider');
            const mainLightSlider = document.getElementById('main-light-slider');
            const fillLightSlider = document.getElementById('fill-light-slider');
            const rimLightSlider = document.getElementById('rim-light-slider');
            const ambientLightValue = document.getElementById('ambient-light-value');
            const mainLightValue = document.getElementById('main-light-value');
            const fillLightValue = document.getElementById('fill-light-value');
            const rimLightValue = document.getElementById('rim-light-value');
            const resetLightingBtn = document.getElementById('reset-lighting-btn');

            // ç¯å¢ƒå…‰æ»‘å—
            if (ambientLightSlider && ambientLightValue) {
                ambientLightSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    ambientLightValue.textContent = value.toFixed(2);
                    if (vrmManager && vrmManager.ambientLight) {
                        vrmManager.ambientLight.intensity = value;
                    }
                });
            }

            // ä¸»å…‰æºæ»‘å—
            if (mainLightSlider && mainLightValue) {
                mainLightSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    mainLightValue.textContent = value.toFixed(2);
                    if (vrmManager && vrmManager.mainLight) {
                        vrmManager.mainLight.intensity = value;
                    }
                });
            }

            // è¡¥å…‰æ»‘å—
            if (fillLightSlider && fillLightValue) {
                fillLightSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    fillLightValue.textContent = value.toFixed(2);
                    if (vrmManager && vrmManager.fillLight) {
                        vrmManager.fillLight.intensity = value;
                    }
                });
            }

            // è½®å»“å…‰æ»‘å—
            if (rimLightSlider && rimLightValue) {
                rimLightSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    rimLightValue.textContent = value.toFixed(2);
                    if (vrmManager && vrmManager.rimLight) {
                        vrmManager.rimLight.intensity = value;
                    }
                });
            }

            // é‡ç½®æ‰“å…‰æŒ‰é’®
            if (resetLightingBtn) {
                resetLightingBtn.addEventListener('click', () => {
                    // é‡ç½®ä¸ºé»˜è®¤å€¼
                    if (ambientLightSlider) {
                        ambientLightSlider.value = 0.08;
                        ambientLightValue.textContent = '0.08';
                        if (vrmManager && vrmManager.ambientLight) {
                            vrmManager.ambientLight.intensity = 0.08;
                        }
                    }
                    if (mainLightSlider) {
                        mainLightSlider.value = 0.06;
                        mainLightValue.textContent = '0.06';
                        if (vrmManager && vrmManager.mainLight) {
                            vrmManager.mainLight.intensity = 0.06;
                        }
                    }
                    if (fillLightSlider) {
                        fillLightSlider.value = 0.12;
                        fillLightValue.textContent = '0.12';
                        if (vrmManager && vrmManager.fillLight) {
                            vrmManager.fillLight.intensity = 0.12;
                        }
                    }
                    if (rimLightSlider) {
                        rimLightSlider.value = 0.8;
                        rimLightValue.textContent = '0.8';
                        if (vrmManager && vrmManager.rimLight) {
                            vrmManager.rimLight.intensity = 0.8;
                        }
                    }
                    showStatus(t('vrm.lighting.lightingReset', 'æ‰“å…‰è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', {}), 2000);
                });
            }


           

            // åº”ç”¨æ‰“å…‰å€¼åˆ°UIå’Œåœºæ™¯
            function applyLightingValues(lighting) {
                if (ambientLightSlider && ambientLightValue) {
                    ambientLightSlider.value = lighting.ambient;
                    ambientLightValue.textContent = lighting.ambient.toFixed(2);
                    if (vrmManager?.ambientLight) {
                        vrmManager.ambientLight.intensity = lighting.ambient;
                    }
                }
                if (mainLightSlider && mainLightValue) {
                    mainLightSlider.value = lighting.main;
                    mainLightValue.textContent = lighting.main.toFixed(2);
                    if (vrmManager?.mainLight) {
                        vrmManager.mainLight.intensity = lighting.main;
                    }
                }
                if (fillLightSlider && fillLightValue) {
                    fillLightSlider.value = lighting.fill;
                    fillLightValue.textContent = lighting.fill.toFixed(2);
                    if (vrmManager?.fillLight) {
                        vrmManager.fillLight.intensity = lighting.fill;
                    }
                }
                if (rimLightSlider && rimLightValue) {
                    rimLightSlider.value = lighting.rim;
                    rimLightValue.textContent = lighting.rim.toFixed(2);
                    if (vrmManager?.rimLight) {
                        vrmManager.rimLight.intensity = lighting.rim;
                    }
                }
            }

            // åŠ è½½è§’è‰²çš„æ‰“å…‰é…ç½®å¹¶åº”ç”¨
            // ã€ä¿ç•™ä½†ç®€åŒ–ã€‘åªåŠ è½½è§’è‰²çš„â€œç›´æ¥æ‰“å…‰é…ç½®â€ï¼Œå»æ‰äº†é¢„è®¾é€»è¾‘
            async function loadCharacterLighting() {
                try {
                    const lanlanName = await getLanlanName();
                    if (!lanlanName) return;

                    const response = await fetch('/api/characters/');
                    if (!response.ok) return;

                    const data = await response.json();
                    const charData = data['çŒ«å¨˜']?.[lanlanName];
                    const lighting = charData?.lighting;

                    // åªå¤„ç†ç›´æ¥ä¿å­˜çš„ lighting å¯¹è±¡
                    if (lighting) {
                        console.log('åŠ è½½è§’è‰²æ‰“å…‰é…ç½®:', lighting);
                        applyLightingValues(lighting);
                    } else {
                        console.log('è§’è‰²æ— è‡ªå®šä¹‰æ‰“å…‰ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ‰“å…‰é…ç½®å¤±è´¥:', error);
                }
            }

            // åˆå§‹åŒ–æ—¶åŠ è½½ VRM æ¨¡å‹åˆ—è¡¨
            await loadVRMModels();

            // æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
            async function checkVoiceModeStatus() {
                try {
                    const lanlanName = await getLanlanName();
                    if (!lanlanName) return { isVoiceMode: false, isCurrent: false };
                    
                    const response = await fetch(`/api/characters/catgirl/${encodeURIComponent(lanlanName)}/voice_mode_status`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (!response.ok) {
                        // å¦‚æœå“åº”ä¸æˆåŠŸï¼Œè®°å½•ä½†ä¸é˜»æ­¢æ“ä½œ
                        console.warn(`æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€å¤±è´¥: HTTP ${response.status}`);
                        return { isVoiceMode: false, isCurrent: false };
                    }
                    
                    const data = await response.json();
                    return {
                        isVoiceMode: data.is_voice_mode || false,
                        isCurrent: data.is_current || false
                    };
                } catch (error) {
                    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        console.warn('æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€è¶…æ—¶ï¼ˆæœåŠ¡å™¨å¯èƒ½æœªå“åº”ï¼‰');
                    } else if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED'))) {
                        console.warn('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿ main_server.py æ­£åœ¨è¿è¡Œ');
                    } else {
                        console.warn('æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€å¤±è´¥:', error);
                    }
                    // è¿æ¥å¤±è´¥æ—¶è¿”å›é»˜è®¤å€¼ï¼Œå…è®¸ç”¨æˆ·ç»§ç»­æ“ä½œ
                    return { isVoiceMode: false, isCurrent: false };
                }
            }

            // ä¿®æ”¹æ¨¡å‹é€‰æ‹©äº‹ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜æ¨¡å‹è®¾ç½®
            modelSelect.addEventListener('change', async (e) => {
                const modelName = e.target.value;

                if (!modelName) return;

                // æ£€æŸ¥è¯­éŸ³æ¨¡å¼çŠ¶æ€
                const voiceStatus = await checkVoiceModeStatus();
                if (voiceStatus.isCurrent && voiceStatus.isVoiceMode) {
                    showStatus(t('live2d.cannotChangeModelInVoiceMode', 'è¯­éŸ³æ¨¡å¼ä¸‹æ— æ³•åˆ‡æ¢æ¨¡å‹ï¼Œè¯·å…ˆåœæ­¢è¯­éŸ³å¯¹è¯'), 3000);
                    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                    if (currentModelInfo && currentModelInfo.name) {
                        e.target.value = currentModelInfo.name;
                    } else {
                        e.target.value = '';
                    }
                    return;
                }

                currentModelInfo = availableModels.find(m => m.name === modelName);
                if (!currentModelInfo) return;

                // è·å–é€‰ä¸­çš„optionå…ƒç´ ï¼Œä»ä¸­è·å–item_id
                const selectedOption = e.target[e.target.selectedIndex];
                const modelSteamId = selectedOption ? selectedOption.dataset.itemId : currentModelInfo.item_id;
                
                // æ›´æ–°currentModelInfoçš„item_idï¼ˆå¦‚æœä»optionè·å–åˆ°äº†ï¼‰
                if (modelSteamId && modelSteamId !== 'undefined') {
                    currentModelInfo.item_id = modelSteamId;
                }

                await loadModel(modelName, currentModelInfo, modelSteamId);

                // ä¸è‡ªåŠ¨ä¿å­˜æ¨¡å‹åˆ°è§’è‰²ï¼Œæ”¹ä¸ºæ ‡è®°ä¸ºæœ‰æœªä¿å­˜æ›´æ”¹ï¼Œç”¨æˆ·éœ€æ‰‹åŠ¨ç‚¹å‡»"ä¿å­˜è®¾ç½®"
                window.hasUnsavedChanges = true;
                console.log('å·²æ ‡è®°ä¸ºæœªä¿å­˜æ›´æ”¹ï¼ˆæ¨¡å‹åˆ‡æ¢ï¼‰ï¼Œè¯·ç‚¹å‡» ä¿å­˜è®¾ç½® æŒä¹…åŒ–åˆ°è§’è‰²é…ç½®ã€‚');
            });

            // åŠ è½½æ¨¡å‹çš„å‡½æ•°
            async function loadModel(modelName, modelInfo, steam_id) {
                if (!modelName || !modelInfo) return;

                // ç¡®ä¿è·å–æ­£ç¡®çš„steam_idï¼Œä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ï¼Œç„¶åä»modelInfoä¸­è·å–
                let finalSteamId = steam_id || modelInfo.item_id;
                console.log('modelInfo:', modelInfo);
                console.log('finalSteamId:', finalSteamId);
                showStatus(t('live2d.loadingModel', `æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelName}...`, { model: modelName }));
                setControlsDisabled(true);

                try {
                    // 1. è·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆæ ¹æ®æ¥æºé€‰æ‹© APIï¼‰
                    let apiUrl = '';
                    if (modelInfo.source === 'user_mods') {
                        apiUrl = `/api/live2d/model_files/${encodeURIComponent(modelName)}`;
                    } else if (finalSteamId && finalSteamId !== 'undefined') {
                        apiUrl = `/api/live2d/model_files_by_id/${finalSteamId}`;
                    } else {
                        apiUrl = `/api/live2d/model_files/${encodeURIComponent(modelName)}`;
                    }
                    
                    // ä½¿ç”¨åŠ©æ‰‹
                    const filesData = await RequestHelper.fetchJson(apiUrl);
                    currentModelFiles = filesData;

                    // 2. Fetch model config
                    let modelJsonUrl;
                    // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„model_config_urlï¼ˆå¦‚æœæœ‰ï¼‰
                    if (filesData.model_config_url) {
                        modelJsonUrl = filesData.model_config_url;
                        console.log('ä½¿ç”¨åç«¯è¿”å›çš„æ¨¡å‹é…ç½®URL:', modelJsonUrl);
                    } else if (modelInfo.source === 'user_mods') {
                        // å¯¹äºç”¨æˆ·modæ¨¡å‹ï¼Œç›´æ¥ä½¿ç”¨modelInfo.pathï¼ˆå·²ç»åŒ…å«/user_mods/è·¯å¾„ï¼‰
                        modelJsonUrl = modelInfo.path;
                        console.log('ä½¿ç”¨ç”¨æˆ·modæ¨¡å‹è·¯å¾„:', modelJsonUrl);
                    } else if (finalSteamId && finalSteamId !== 'undefined') {
                        // å¦‚æœæä¾›äº†finalSteamIdä½†æ²¡æœ‰model_config_urlï¼Œä½¿ç”¨åŸæ¥çš„æ–¹å¼æ„å»ºURLï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
                        modelJsonUrl = `/workshop/${finalSteamId}/${modelName}.model3.json`;
                        console.log('å…¼å®¹æ¨¡å¼ - æ„å»ºçš„æ¨¡å‹URL(å¸¦steam_id):', modelJsonUrl);
                    } else {
                        // å¦åˆ™ä½¿ç”¨åŸæ¥çš„è·¯å¾„
                        modelJsonUrl = modelInfo.path;
                        console.log('æ„å»ºçš„æ¨¡å‹URL(æœ¬åœ°):', modelJsonUrl);
                    }
                    const modelConfigRes = await fetch(modelJsonUrl);
                    if (!modelConfigRes.ok) throw new Error(t('live2d.modelConfigFetchFailed', `æ— æ³•è·å–æ¨¡å‹é…ç½®: ${modelConfigRes.statusText}`, { status: modelConfigRes.statusText }));
                    const modelConfig = await modelConfigRes.json();

                    // 3. Add URL context for the loader
                    modelConfig.url = modelJsonUrl;

                    // 4. Inject PreviewAll motion group AND ensure all expressions are referenced
                    if (!modelConfig.FileReferences) modelConfig.FileReferences = {};

                    // Motions
                    if (!modelConfig.FileReferences.Motions) modelConfig.FileReferences.Motions = {};
                    // åªæœ‰å½“æ¨¡å‹æœ‰åŠ¨ä½œæ–‡ä»¶æ—¶æ‰æ·»åŠ PreviewAllç»„
                    if (currentModelFiles.motion_files.length > 0) {
                        modelConfig.FileReferences.Motions.PreviewAll = currentModelFiles.motion_files.map(file => ({
                            File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                        }));
                    }

                    // Expressions: Overwrite with all available expression files for preview purposes.
                    modelConfig.FileReferences.Expressions = currentModelFiles.expression_files.map(file => ({
                        Name: file.split('/').pop().replace('.exp3.json', ''),  // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åä½œä¸ºåç§°
                        File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                    }));

                    // 5. Load preferences
                    const preferences = await window.live2dManager.loadUserPreferences();
                    console.log('åŠ è½½çš„åå¥½è®¾ç½®:', preferences);
                    console.log('å½“å‰æ¨¡å‹è·¯å¾„:', modelInfo.path);
                    const modelPreferences = preferences.find(p => p && p.model_path === modelInfo.path) || null;
                    console.log('åŒ¹é…çš„æ¨¡å‹åå¥½:', modelPreferences);

                    // 6. Load model FROM THE MODIFIED OBJECT
                    await window.live2dManager.loadModel(modelConfig, {
                        loadEmotionMapping: true,
                        dragEnabled: true,
                        wheelEnabled: true,
                        preferences: modelPreferences
                    });
                    live2dModel = window.live2dManager.getCurrentModel();

                    // æ·»åŠ æ¨¡å‹äº¤äº’ç›‘å¬å™¨ï¼Œè·Ÿè¸ªä½ç½®å’Œç¼©æ”¾å˜åŒ–
                    if (live2dModel && live2dModel.internalModel) {
                        const canvas = document.getElementById('live2d-canvas');
                        if (canvas) {
                            // ä½ç½®å’Œç¼©æ”¾çš„è‡ªåŠ¨ä¿å­˜ç°åœ¨ç”± live2d-interaction.js å¤„ç†
                        }
                    }

                    updateSelectWithOptions(motionSelect, currentModelFiles.motion_files, t('live2d.selectMotion', 'é€‰æ‹©åŠ¨ä½œ'), 'motion');
                    updateSelectWithOptions(expressionSelect, currentModelFiles.expression_files, t('live2d.selectExpression', 'é€‰æ‹©è¡¨æƒ…'), 'expression');

                    // æ›´æ–°å¸¸é©»è¡¨æƒ…é€‰æ‹©æ¡†ï¼ˆåªæ˜¾ç¤º .exp3.json æ–‡ä»¶ï¼‰
                    await updatePersistentExpressionSelect();

                    // 7. Load current emotion mapping for this model
                    await loadEmotionMappingForModel(modelName);

                    // åŠ è½½å¹¶æ˜¾ç¤ºå·²é…ç½®çš„å¸¸é©»è¡¨æƒ…
                    await loadPersistentExpressions();

                    // å¦‚æœæ²¡æœ‰åŠ¨ä½œæ–‡ä»¶ï¼Œç¦ç”¨åŠ¨ä½œç›¸å…³æ§ä»¶
                    if (currentModelFiles.motion_files.length === 0) {
                        motionSelect.disabled = true;
                        playMotionBtn.disabled = true;
                        motionSelect.innerHTML = `<option value="">${t('live2d.noMotionFiles', 'æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶')}</option>`;
                    }
                    setControlsDisabled(false);
                    showStatus(t('live2d.modelLoadSuccess', `æ¨¡å‹ ${modelName} åŠ è½½æˆåŠŸ`, { model: modelName }));

                } catch (error) {
                    showStatus(t('live2d.modelLoadFailed', `åŠ è½½æ¨¡å‹ ${modelName} å¤±è´¥`, { model: modelName }));
                    console.error(error);
                    setControlsDisabled(false);
                }
            }

            playMotionBtn.addEventListener('click', () => {
                if (!live2dModel || !motionSelect.value) return;

                // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ä½œæ–‡ä»¶
                if (currentModelFiles.motion_files.length === 0) {
                    showStatus(t('live2d.noMotionFilesStatus', 'æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶'), 2000);
                    return;
                }

                const motionIndex = currentModelFiles.motion_files.indexOf(motionSelect.value);
                if (motionIndex > -1) {
                    try {
                        live2dModel.motion('PreviewAll', motionIndex, 3);
                        showStatus(t('live2d.playingMotion', `æ’­æ”¾åŠ¨ä½œ: ${motionSelect.value}`, { motion: motionSelect.value }), 1000);
                    } catch (error) {
                        console.error('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                        showStatus(t('live2d.playMotionFailed', `æ’­æ”¾åŠ¨ä½œå¤±è´¥: ${motionSelect.value}`, { motion: motionSelect.value }), 2000);
                    }
                } else {
                    showStatus(t('live2d.motionFileNotExists', 'åŠ¨ä½œæ–‡ä»¶ä¸å­˜åœ¨'), 2000);
                }
            });

            playExpressionBtn.addEventListener('click', () => {
                if (!live2dModel || !expressionSelect.value) return;
                // ä»å®Œæ•´è·¯å¾„ä¸­æå–è¡¨æƒ…åç§°ï¼ˆå»æ‰è·¯å¾„å’Œæ‰©å±•åï¼‰
                const expressionName = expressionSelect.value.split('/').pop().replace('.exp3.json', '');
                console.log('æ’­æ”¾è¡¨æƒ…:', expressionName); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                try {
                    live2dModel.expression(expressionName);
                    showStatus(t('live2d.playingExpression', `æ’­æ”¾è¡¨æƒ…: ${expressionName}`, { expression: expressionName }), 1000);
                } catch (error) {
                    console.error('æ’­æ”¾è¡¨æƒ…å¤±è´¥:', error);
                    showStatus(t('live2d.playExpressionFailed', `æ’­æ”¾è¡¨æƒ…å¤±è´¥: ${expressionName}`, { expression: expressionName }), 2000);
                }
            });

            emotionManagerBtn.addEventListener('click', () => {
                if (!currentModelInfo) return;
                openModal('/live2d_emotion_manager');
            });

            savePositionBtn.addEventListener('click', async () => {
                // VRMæ¨¡å¼ä¸‹ï¼Œå³ä½¿æ¨¡å‹æœªåŠ è½½ï¼Œåªè¦æœ‰é€‰æ‹©çš„æ¨¡å‹å°±å¯ä»¥ä¿å­˜
                if (currentModelType === 'vrm') {
                    const selectedModelPath = vrmModelSelect ? vrmModelSelect.value : null;
                    if (!selectedModelPath) {
                        showStatus(t('live2d.pleaseSelectModel', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªVRMæ¨¡å‹'), 2000);
                        return;
                    }
                    // å¦‚æœæ²¡æœ‰currentModelInfoï¼Œä½¿ç”¨å½“å‰é€‰æ‹©çš„æ¨¡å‹è·¯å¾„åˆ›å»º
                    if (!currentModelInfo) {
                        currentModelInfo = {
                            name: selectedModelPath,
                            path: selectedModelPath,
                            type: 'vrm'
                        };
                    }
                } else {
                    // Live2Dæ¨¡å¼ä¸‹éœ€è¦currentModelInfo
                    if (!currentModelInfo) return;
                }
                
                showStatus(t('live2d.savingSettings', 'æ­£åœ¨ä¿å­˜è®¾ç½®...'));

                let positionSuccess = false;
                let modelSuccess = false;

                // æ ¹æ®æ¨¡å‹ç±»å‹ä¿å­˜ä¸åŒçš„è®¾ç½®
                if (currentModelType === 'vrm') {
                    // VRM æ¨¡å¼ï¼šä¿å­˜æ¨¡å‹è®¾ç½®ï¼ˆåŠ¨ä½œå·²æ”¹ä¸ºè‡ªåŠ¨å¾ªç¯æ’­æ”¾ï¼Œä¸å†éœ€è¦ä¿å­˜ï¼‰
                    modelSuccess = await saveModelToCharacter(currentModelInfo.name, null, null);
                } else {
                    // Live2D æ¨¡å¼ï¼šä¿å­˜ä½ç½®ã€ç¼©æ”¾å’Œæ¨¡å‹è®¾ç½®
                    if (!live2dModel) {
                        showStatus(t('live2d.pleaseLoadModel', 'è¯·å…ˆåŠ è½½æ¨¡å‹'), 2000);
                        return;
                    }

                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    console.log('ä¿å­˜è®¾ç½® - æ¨¡å‹è·¯å¾„:', currentModelInfo.path);
                    console.log('ä¿å­˜è®¾ç½® - å½“å‰ä½ç½®:', { x: live2dModel.x, y: live2dModel.y });
                    console.log('ä¿å­˜è®¾ç½® - å½“å‰ç¼©æ”¾:', { x: live2dModel.scale.x, y: live2dModel.scale.y });

                    // ä¿å­˜ä½ç½®å’Œç¼©æ”¾
                    positionSuccess = await window.live2dManager.saveUserPreferences(
                        currentModelInfo.path,
                        { x: live2dModel.x, y: live2dModel.y },
                        { x: live2dModel.scale.x, y: live2dModel.scale.y }
                    );

                    // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²ï¼ŒåŒæ—¶ä¼ å…¥item_id
                    modelSuccess = await saveModelToCharacter(currentModelInfo.name, currentModelInfo.item_id);
                }

                if (currentModelType === 'vrm') {
                    // VRM æ¨¡å¼ï¼šåªæ˜¾ç¤ºæ¨¡å‹ä¿å­˜ç»“æœ
                    if (modelSuccess) {
                        showStatus(t('live2d.settingsSaved', 'æ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸ!'), 2000);
                        window.hasUnsavedChanges = false;
                        // ç«‹å³é€šçŸ¥è§’è‰²ç®¡ç†é¡µé¢åˆ·æ–°ï¼ˆä½¿ç”¨ postMessageï¼‰
                        if (window.opener && !window.opener.closed) {
                            try {
                                window.opener.postMessage({
                                    action: 'model_saved',
                                    timestamp: Date.now()
                                }, window.location.origin);
                                console.log('[æ¶ˆæ¯å‘é€] VRMæ¨¡å‹ä¿å­˜æˆåŠŸï¼Œç«‹å³å‘é€ model_saved æ¶ˆæ¯');
                            } catch (e) {
                                console.warn('å‘é€ä¿å­˜æˆåŠŸæ¶ˆæ¯å¤±è´¥:', e);
                            }
                        }
                        // é€šçŸ¥ä¸»é¡µé‡æ–°åŠ è½½æ¨¡å‹
                        sendMessageToMainPage('reload_model');
                    } else {
                        showStatus(t('live2d.saveFailedGeneral', 'ä¿å­˜å¤±è´¥!'), 2000);
                    }
                } else {
                    // Live2D æ¨¡å¼ï¼šæ˜¾ç¤ºä½ç½®å’Œæ¨¡å‹ä¿å­˜ç»“æœ
                    if (positionSuccess && modelSuccess) {
                        showStatus(t('live2d.settingsSaved', 'ä½ç½®å’Œæ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸ!'), 2000);
                        window.hasUnsavedChanges = false; // ä¿å­˜æˆåŠŸåé‡ç½®æ ‡å¿—
                        // é€šçŸ¥ä¸»é¡µé‡æ–°åŠ è½½æ¨¡å‹
                        sendMessageToMainPage('reload_model');
                    } else if (positionSuccess) {
                        showStatus(t('live2d.positionSavedModelFailed', 'ä½ç½®ä¿å­˜æˆåŠŸï¼Œæ¨¡å‹è®¾ç½®ä¿å­˜å¤±è´¥!'), 2000);
                    } else if (modelSuccess) {
                        showStatus(t('live2d.modelSavedPositionFailed', 'æ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸï¼Œä½ç½®ä¿å­˜å¤±è´¥!'), 2000);
                        // å³ä½¿ä½ç½®ä¿å­˜å¤±è´¥ï¼Œæ¨¡å‹è®¾ç½®æˆåŠŸä¹Ÿåº”è¯¥é€šçŸ¥ä¸»é¡µé‡æ–°åŠ è½½
                        sendMessageToMainPage('reload_model');
                    } else {
                        showStatus(t('live2d.saveFailedGeneral', 'ä¿å­˜å¤±è´¥!'), 2000);
                    }
                }
            });

            // è¿”å›ä¸»é¡µ/å…³é—­æŒ‰é’®
            backToMainBtn.addEventListener('click', async () => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
                if (window.hasUnsavedChanges) {
                    const message = t('dialogs.unsavedChanges', 'æ‚¨æœ‰æœªä¿å­˜çš„è®¾ç½®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
                    const title = t('dialogs.confirmLeave', 'ç¡®è®¤ç¦»å¼€');
                    const confirmLeave = await showConfirm(message, title, { danger: true });
                    console.log('ç”¨æˆ·é€‰æ‹©:', confirmLeave ? 'ç¡®å®šç¦»å¼€' : 'å–æ¶ˆ');
                    if (!confirmLeave) {
                        return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸ç¦»å¼€
                    }
                    // ç”¨æˆ·ç¡®è®¤ç¦»å¼€ï¼Œé‡ç½®æœªä¿å­˜çŠ¶æ€ï¼Œé¿å…è¢« beforeunload æ‹¦æˆª
                    window.hasUnsavedChanges = false;
                } else {
                    console.log('æ²¡æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç›´æ¥è¿”å›');
                }

                // å¦‚æœå¤„äºå…¨å±çŠ¶æ€ï¼Œå…ˆé€€å‡ºå…¨å±
                if (isFullscreen()) {
                    try {
                        await exitFullscreen();
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.log('é€€å‡ºå…¨å±å¤±è´¥:', e);
                    }
                }

                // æ ¹æ®çª—å£ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
                if (isPopupWindow) {
                    // å¦‚æœæ˜¯å¼¹å‡ºçª—å£ï¼Œåœ¨å…³é—­å‰å‘é€åˆ·æ–°æ¶ˆæ¯
                    if (window.opener && !window.opener.closed) {
                        try {
                            window.opener.postMessage({
                                action: 'model_saved',
                                timestamp: Date.now()
                            }, window.location.origin);
                            console.log('[æ¶ˆæ¯å‘é€] çª—å£å…³é—­å‰å‘é€ model_saved æ¶ˆæ¯');
                        } catch (e) {
                            console.warn('å‘é€å…³é—­æ¶ˆæ¯å¤±è´¥:', e);
                        }
                    }
                    // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ¶ˆæ¯å‘é€
                    setTimeout(() => {
                        window.close();
                    }, 100);
                } else {
                    // å¦‚æœæ˜¯ä¸»çª—å£è·³è½¬ï¼Œç›´æ¥è·³è½¬å³å¯ï¼Œæ–°é¡µé¢ä¼šè‡ªåŠ¨åŠ è½½æœ€æ–°é…ç½®
                    window.location.href = '/';
                }
            });

            // ä¸Šä¼ æ¨¡å‹åŠŸèƒ½
            uploadBtn.addEventListener('click', () => {
                // æ ¹æ®å½“å‰æ¨¡å‹ç±»å‹é€‰æ‹©ä¸åŒçš„æ–‡ä»¶é€‰æ‹©å™¨
                if (currentModelType === 'vrm') {
                    vrmFileUpload.click();
                } else {
                    modelUpload.click();
                }
            });

            // Live2Dæ¨¡å‹ä¸Šä¼ ï¼ˆæ–‡ä»¶å¤¹ï¼‰
            modelUpload.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                uploadStatus.textContent = t('live2d.uploadingModel', 'æ­£åœ¨ä¸Šä¼ æ¨¡å‹...');
                uploadStatus.style.color = '#4f8cff';
                uploadBtn.disabled = true;

                try {
                    const formData = new FormData();

                    // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°FormData
                    for (const file of files) {
                        // ä¿ç•™æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
                        formData.append('files', file, file.webkitRelativePath || file.name);
                    }

                    const response = await fetch('/api/live2d/upload_model', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        uploadStatus.textContent = t('live2d.uploadSuccess', `âœ“ ${result.message}`, { message: result.message });
                        uploadStatus.style.color = '#28a745';

                        // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
                        setTimeout(async () => {
                            try {
                                const modelsResponse = await fetch('/api/live2d/models');
                                availableModels = await modelsResponse.json();
                                modelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                                availableModels.forEach(model => {
                                    const option = document.createElement('option');
                                    option.value = model.name;
                                    // ä½¿ç”¨display_nameï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ˜¾ç¤ºæ›´å‹å¥½çš„åç§°
                                    option.textContent = model.display_name || model.name;
                                    modelSelect.appendChild(option);
                                });

                                // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„æ¨¡å‹
                                if (result.model_name) {
                                    modelSelect.value = result.model_name;
                                    modelSelect.dispatchEvent(new Event('change'));
                                }

                                uploadStatus.textContent = '';
                            } catch (e) {
                                console.error('é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
                            }
                        }, 1500);
                    } else {
                        uploadStatus.textContent = t('live2d.uploadFailed', `âœ— ${result.error}`, { error: result.error });
                        uploadStatus.style.color = '#dc3545';
                        setTimeout(() => {
                            uploadStatus.textContent = '';
                        }, 5000);
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    uploadStatus.textContent = t('live2d.uploadError', `âœ— ä¸Šä¼ å¤±è´¥: ${error.message}`, { error: error.message });
                    uploadStatus.style.color = '#dc3545';
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 5000);
                } finally {
                    uploadBtn.disabled = false;
                    // é‡ç½®file inputä»¥å…è®¸é‡æ–°é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶å¤¹
                    modelUpload.value = '';
                }
            });

            // VRMæ¨¡å‹ä¸Šä¼ ï¼ˆå•ä¸ªæ–‡ä»¶ï¼‰
            vrmFileUpload.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                const vrmFile = files.find(f => f.name.toLowerCase().endsWith('.vrm'));
                if (!vrmFile) {
                    uploadStatus.textContent = t('live2d.uploadVRMFailed', 'âœ— è¯·é€‰æ‹©.vrmæ–‡ä»¶', { error: 'è¯·é€‰æ‹©.vrmæ–‡ä»¶' });
                    uploadStatus.style.color = '#dc3545';
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 3000);
                    vrmFileUpload.value = '';
                    return;
                }

                uploadStatus.textContent = t('live2d.uploadingVRMModel', 'æ­£åœ¨ä¸Šä¼ VRMæ¨¡å‹...');
                uploadStatus.style.color = '#4f8cff';
                uploadBtn.disabled = true;

                try {
                    const formData = new FormData();
                    // VRMæ¨¡å‹åªéœ€è¦ä¸Šä¼ å•ä¸ª.vrmæ–‡ä»¶
                    // æ³¨æ„ï¼šåç«¯å‚æ•°åæ˜¯ fileï¼ˆå•æ•°ï¼‰ï¼Œä¸æ˜¯ files
                    formData.append('file', vrmFile, vrmFile.name);

                    const response = await fetch('/api/model/vrm/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        uploadStatus.textContent = t('live2d.uploadVRMSuccess', `âœ“ ${result.message}`, { message: result.message });
                        uploadStatus.style.color = '#28a745';

                        // é‡æ–°åŠ è½½VRMæ¨¡å‹åˆ—è¡¨
                        setTimeout(async () => {
                            try {
                                await loadVRMModels();
                                // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„æ¨¡å‹
                                if (result.model_path && vrmModelSelect) {
                                    // å°è¯•åŒ¹é…æ¨¡å‹è·¯å¾„
                                    const modelPath = result.model_path;
                                    // å…ˆå°è¯•ç›´æ¥åŒ¹é…å®Œæ•´è·¯å¾„
                                    let option = Array.from(vrmModelSelect.options).find(opt => opt.value === modelPath);
                                    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é…æ–‡ä»¶å
                                    if (!option && result.model_name) {
                                        const fileName = result.model_name + '.vrm';
                                        option = Array.from(vrmModelSelect.options).find(opt => {
                                            const optPath = opt.value;
                                            return optPath && (optPath.endsWith(fileName) || optPath.includes(fileName));
                                        });
                                    }
                                    
                                    if (option) {
                                        vrmModelSelect.value = option.value;
                                        // è§¦å‘changeäº‹ä»¶ä»¥åŠ è½½æ¨¡å‹
                                        vrmModelSelect.dispatchEvent(new Event('change'));
                                    } else {
                                        console.warn('æ— æ³•è‡ªåŠ¨é€‰æ‹©ä¸Šä¼ çš„æ¨¡å‹ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©');
                                    }
                                }

                                uploadStatus.textContent = '';
                            } catch (e) {
                                console.error('é‡æ–°åŠ è½½VRMæ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
                            }
                        }, 1500);
                    } else {
                        uploadStatus.textContent = t('live2d.uploadVRMFailed', `âœ— ${result.error}`, { error: result.error });
                        uploadStatus.style.color = '#dc3545';
                        setTimeout(() => {
                            uploadStatus.textContent = '';
                        }, 5000);
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    uploadStatus.textContent = t('live2d.uploadVRMError', `âœ— ä¸Šä¼ å¤±è´¥: ${error.message}`, { error: error.message });
                    uploadStatus.style.color = '#dc3545';
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 5000);
                } finally {
                    uploadBtn.disabled = false;
                    // é‡ç½®file inputä»¥å…è®¸é‡æ–°é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
                    vrmFileUpload.value = '';
                }
            });

            // æ›´æ–°å¸¸é©»è¡¨æƒ…é€‰æ‹©æ¡†
            async function updatePersistentExpressionSelect() {
                const persistentSelect = document.getElementById('persistent-expression-select');

                if (!currentModelFiles || !currentModelFiles.expression_files) {
                    persistentSelect.disabled = true;
                    return;
                }

                // åªæ˜¾ç¤º .exp3.json æ–‡ä»¶
                const exp3Files = currentModelFiles.expression_files.filter(file => file.endsWith('.exp3.json'));

                persistentSelect.innerHTML = `<option value="" data-i18n="live2d.selectPersistentExpression">${t('live2d.selectPersistentExpression', 'é€‰æ‹©å¸¸é©»è¡¨æƒ…')}</option>`;
                exp3Files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    const displayName = file.split('/').pop().replace('.exp3.json', '');
                    option.textContent = displayName;
                    persistentSelect.appendChild(option);
                });

                persistentSelect.disabled = false;
            }

            // åŠ è½½å·²é…ç½®çš„å¸¸é©»è¡¨æƒ…
            async function loadPersistentExpressions() {
                const persistentList = document.getElementById('persistent-list');
                if (!currentModelInfo) {
                    persistentList.style.display = 'none';
                    return;
                }

                try {
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`);
                    const data = await res.json();

                    if (data && data.success && data.config && data.config.expressions && data.config.expressions['å¸¸é©»']) {
                        const persistentExpressions = data.config.expressions['å¸¸é©»'];
                        if (persistentExpressions && persistentExpressions.length > 0) {
                            persistentList.innerHTML = '';
                            persistentExpressions.forEach(file => {
                                const item = document.createElement('div');
                                item.style.cssText = 'padding: 4px 8px; margin: 2px 0; background: #f0f0f0; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;';
                                const fileName = file.split('/').pop().replace('.exp3.json', '');
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = fileName;
                                const deleteBtn = document.createElement('button');
                                deleteBtn.textContent = t('live2d.delete', 'åˆ é™¤');
                                deleteBtn.style.cssText = 'background: #dc3545; color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 11px;';
                                deleteBtn.addEventListener('click', () => removePersistentExpression(file));
                                item.appendChild(nameSpan);
                                item.appendChild(deleteBtn);
                                persistentList.appendChild(item);
                            });
                            persistentList.style.display = 'block';
                        } else {
                            persistentList.style.display = 'none';
                        }
                    } else {
                        persistentList.style.display = 'none';
                    }
                } catch (e) {
                    console.error('åŠ è½½å¸¸é©»è¡¨æƒ…å¤±è´¥:', e);
                    persistentList.style.display = 'none';
                }
            }

            // æ·»åŠ å¸¸é©»è¡¨æƒ…
            const persistentSelect = document.getElementById('persistent-expression-select');
            persistentSelect.addEventListener('change', async () => {
                const selectedFile = persistentSelect.value;
                if (!selectedFile || !currentModelInfo) return;

                // é˜²æ­¢é‡å¤æ“ä½œ
                if (persistentSelect.disabled) return;
                persistentSelect.disabled = true;

                try {
                    // è·å–å½“å‰é…ç½®
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`);
                    const data = await res.json();

                    const currentConfig = data && data.success ? (data.config || { motions: {}, expressions: {} }) : { motions: {}, expressions: {} };

                    // ç¡®ä¿expressionså¯¹è±¡å­˜åœ¨
                    if (!currentConfig.expressions) {
                        currentConfig.expressions = {};
                    }

                    // ç¡®ä¿å¸¸é©»è¡¨æƒ…æ•°ç»„å­˜åœ¨
                    if (!currentConfig.expressions['å¸¸é©»']) {
                        currentConfig.expressions['å¸¸é©»'] = [];
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (currentConfig.expressions['å¸¸é©»'].includes(selectedFile)) {
                        showStatus(t('live2d.persistentExpressionExists', 'è¯¥è¡¨æƒ…å·²æ·»åŠ ä¸ºå¸¸é©»è¡¨æƒ…'), 2000);
                        persistentSelect.value = '';
                        return; // æ³¨æ„ï¼šè¿™é‡Œreturnåä¼šåœ¨finallyä¸­æ¢å¤disabledçŠ¶æ€
                    }

                    // æ·»åŠ åˆ°å¸¸é©»è¡¨æƒ…åˆ—è¡¨
                    currentConfig.expressions['å¸¸é©»'].push(selectedFile);

                    // ä¿å­˜é…ç½®
                    const saveRes = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(currentConfig)
                    });

                    const saveData = await saveRes.json();
                    if (saveData.success) {
                        showStatus(t('live2d.persistentExpressionAdded', 'å¸¸é©»è¡¨æƒ…å·²æ·»åŠ '), 2000);
                        await loadPersistentExpressions();
                        persistentSelect.value = '';
                    } else {
                        showStatus(t('live2d.persistentExpressionAddFailed', 'æ·»åŠ å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                        persistentSelect.value = '';
                    }
                } catch (e) {
                    console.error('æ·»åŠ å¸¸é©»è¡¨æƒ…å¤±è´¥:', e);
                    showStatus(t('live2d.persistentExpressionAddFailed', 'æ·»åŠ å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                    persistentSelect.value = '';
                } finally {
                    persistentSelect.disabled = false;
                }
            });

            // åˆ é™¤å¸¸é©»è¡¨æƒ…
            window.removePersistentExpression = async function (file) {
                if (!currentModelInfo) return;

                try {
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`);
                    const data = await res.json();

                    const currentConfig = data && data.success ? (data.config || { motions: {}, expressions: {} }) : { motions: {}, expressions: {} };

                    if (currentConfig.expressions && currentConfig.expressions['å¸¸é©»']) {
                        const index = currentConfig.expressions['å¸¸é©»'].indexOf(file);
                        if (index > -1) {
                            currentConfig.expressions['å¸¸é©»'].splice(index, 1);

                            const saveRes = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(currentConfig)
                            });

                            const saveData = await saveRes.json();
                            if (saveData.success) {
                                showStatus(t('live2d.persistentExpressionRemoved', 'å¸¸é©»è¡¨æƒ…å·²åˆ é™¤'), 2000);
                                await loadPersistentExpressions();
                            } else {
                                showStatus(t('live2d.persistentExpressionRemoveFailed', 'åˆ é™¤å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                            }
                        }
                    }
                } catch (e) {
                    console.error('åˆ é™¤å¸¸é©»è¡¨æƒ…å¤±è´¥:', e);
                    showStatus(t('live2d.persistentExpressionRemoveFailed', 'åˆ é™¤å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                }
            };

            // ä¿å­˜æŒ‰é’®å·²ç§»é™¤ï¼Œå› ä¸ºè¡¨æƒ…åœ¨æ·»åŠ /åˆ é™¤æ—¶å·²è‡ªåŠ¨ä¿å­˜

            // Helper functions
            function setControlsDisabled(disabled) {
                motionSelect.disabled = disabled;
                expressionSelect.disabled = disabled;
                playMotionBtn.disabled = disabled;
                playExpressionBtn.disabled = disabled;
                emotionManagerBtn.disabled = disabled;
                savePositionBtn.disabled = disabled;
                const persistentSelect = document.getElementById('persistent-expression-select');
                if (persistentSelect) persistentSelect.disabled = disabled;
            }

            function updateSelectWithOptions(select, options, defaultText, type) {
                select.innerHTML = `<option value="">${defaultText}</option>`;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;

                    if (type === 'expression') {
                        const displayName = opt.split('/').pop().replace('.exp3.json', '');
                        option.textContent = displayName;
                    } else if (type === 'motion') {
                        const displayName = opt.split('/').pop().replace('.motion3.json', '');
                        option.textContent = displayName;
                    } else {
                        option.textContent = opt;
                    }
                    select.appendChild(option);
                });
            }

            function openModal(url) {
                const modal = document.createElement('div');
                modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;`;

                const iframeContainer = document.createElement('div');
                iframeContainer.style.cssText = `background: white; border-radius: 15px; width: 95%; height: 95%; max-width: 1500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;`;

                const header = document.createElement('div');
                header.style.cssText = `padding: 12px 20px; background: #f1f3f5; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;`;

                const title = document.createElement('h3');
                title.textContent = t('emotion.manager', 'æƒ…æ„Ÿé…ç½®ç®¡ç†å™¨');
                title.style.cssText = 'margin: 0;';

                const closeButton = document.createElement('button');
                closeButton.textContent = 'Ã—';
                closeButton.style.cssText = `background: none; border: none; font-size: 24px; cursor: pointer;`;

                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.cssText = 'width: 100%; height: 100%; border: none;';

                const closeModal = () => {
                    modal.remove();
                    if (currentModelInfo) {
                        modelSelect.value = currentModelInfo.name;
                        modelSelect.dispatchEvent(new Event('change'));
                    }
                };

                closeButton.onclick = closeModal;
                header.appendChild(title);
                header.appendChild(closeButton);
                iframeContainer.appendChild(header);
                iframeContainer.appendChild(iframe);
                modal.appendChild(iframeContainer);
                document.body.appendChild(modal);
            }

            // ===== æƒ…ç»ªæ˜ å°„åŠ è½½ =====
            async function loadEmotionMappingForModel(modelName) {
                currentEmotionMapping = null;
                try {
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(modelName)}`);
                    const data = await res.json();
                    if (data && data.success && data.config) {
                        currentEmotionMapping = data.config;
                    } else {
                        currentEmotionMapping = { motions: {}, expressions: {} };
                    }
                } catch (e) {
                    currentEmotionMapping = { motions: {}, expressions: {} };
                }
            }
        
            // æ™ºèƒ½æ£€æµ‹å¹¶ä¿®æ­£ VRM æ¨¡å‹æœå‘
            // ã€å¼ºåŠ›è°ƒè¯•ç‰ˆã€‘æ™ºèƒ½æ£€æµ‹å¹¶ä¿®æ­£ VRM æ¨¡å‹æœå‘
            function autoCorrectVRMOrientation(vrm) {
                console.log("ã€è°ƒè¯•å¼€å§‹ã€‘å‡†å¤‡æ£€æµ‹æ¨¡å‹æœå‘...");
                console.log("ã€è°ƒè¯•ã€‘ä¼ å…¥çš„ vrm å¯¹è±¡æ˜¯:", vrm);

                // 1. æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨
                if (!vrm) {
                    console.error("ã€è°ƒè¯•å¤±è´¥ã€‘ä¼ å…¥çš„ vrm æ˜¯ç©ºçš„ (null/undefined)ï¼æ— æ³•æ£€æµ‹ã€‚");
                    // å°è¯•å» vrmManager é‡Œæ‰¾ä¸€ä¸‹å¤‡ç”¨çš„
                    if (window.vrmManager && window.vrmManager.model) {
                        console.log("ã€è°ƒè¯•ã€‘å°è¯•ä½¿ç”¨ window.vrmManager.model æ›¿è¡¥...");
                        vrm = window.vrmManager.model;
                    } else {
                        return; 
                    }
                }

                // 2. æ£€æŸ¥ Humanoid ç»„ä»¶
                if (!vrm.humanoid) {
                    console.error("ã€è°ƒè¯•å¤±è´¥ã€‘æ¨¡å‹å­˜åœ¨ï¼Œä½†æ²¡æœ‰ Humanoid (äººå½¢éª¨éª¼) ç»„ä»¶ï¼");
                    return;
                }

                try {
                    const humanoid = vrm.humanoid;
                    const scene = vrm.scene;

                    console.log("ã€è°ƒè¯•ã€‘æ­£åœ¨å¼ºåˆ¶åˆ·æ–°éª¨éª¼çŸ©é˜µ...");
                    scene.updateMatrixWorld(true);
                    
                    const footNode = humanoid.getNormalizedBoneNode('leftFoot');
                    const toesNode = humanoid.getNormalizedBoneNode('leftToes');

                    if (footNode && toesNode) {
                        const footPos = new THREE.Vector3();
                        const toesPos = new THREE.Vector3();

                        footNode.getWorldPosition(footPos);
                        toesNode.getWorldPosition(toesPos);

                        console.log(`ã€VRM Checkã€‘æ•°æ®è¯»å–æˆåŠŸ -> è„šè·ŸZ: ${footPos.z.toFixed(4)}, è„šå°–Z: ${toesPos.z.toFixed(4)}`);

                        if (toesPos.z < footPos.z - 0.001) {
                            console.log('ã€VRM Checkã€‘åˆ¤å®šç»“æœï¼šèƒŒå¯¹å±å¹• -> ğŸ”„ æ‰§è¡Œæ—‹è½¬ 180 åº¦');
                            scene.rotation.y = Math.PI; 
                        } else {
                            console.log('ã€VRM Checkã€‘åˆ¤å®šç»“æœï¼šæ­£å¯¹å±å¹• -> âœ… ä¿æŒåŸæ ·');
                            scene.rotation.y = 0; 
                        }
                    } else {
                        console.warn('ã€VRM Checkã€‘âš ï¸ æœªæ‰¾åˆ°è„šéƒ¨éª¨éª¼ (leftFoot æˆ– leftToes ç¼ºå¤±)ï¼Œæ— æ³•åˆ¤æ–­ã€‚');
                    }
                } catch (e) {
                    console.error('ã€VRM Checkã€‘âŒ æ£€æµ‹è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸:', e);
                }
            }
            // åŠ è½½å½“å‰è§’è‰²æ¨¡å‹çš„å‡½æ•°
            async function loadCurrentCharacterModel() {
                try {
                    // è·å–è§’è‰²åç§°
                    const lanlanName = await getLanlanName();
                    if (!lanlanName) {
                        console.log('æœªæ‰¾åˆ°è§’è‰²åç§°ï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½');
                        return;
                    }

                    // è·å–è§’è‰²é…ç½®
                    const charResponse = await fetch('/api/characters');
                    if (!charResponse.ok) {
                        console.log('æ— æ³•è·å–è§’è‰²é…ç½®');
                        return;
                    }
                    const charactersData = await charResponse.json();
                    const catgirlConfig = charactersData['çŒ«å¨˜']?.[lanlanName];
                    
                    if (!catgirlConfig) {
                        console.log(`æœªæ‰¾åˆ°è§’è‰² ${lanlanName} çš„é…ç½®`);
                        return;
                    }

                    // æ£€æŸ¥æ¨¡å‹ç±»å‹
                    const modelType = catgirlConfig.model_type || (catgirlConfig.vrm ? 'vrm' : 'live2d');
                    
                    if (modelType === 'vrm' && catgirlConfig.vrm) {
                        // VRM æ¨¡å‹
                        const vrmModelPath = catgirlConfig.vrm;
                        console.log(`è‡ªåŠ¨åŠ è½½è§’è‰² ${lanlanName} çš„ VRM æ¨¡å‹: ${vrmModelPath}`);
                        showStatus(t('live2d.loadingCharacterModel', `æ­£åœ¨åŠ è½½è§’è‰² ${lanlanName} çš„ VRM æ¨¡å‹...`, { name: lanlanName }));
                        
                        // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                        if (vrmModelSelect) {
                            vrmModelSelect.value = vrmModelPath;
                        }
                        
                        // è®¾ç½®å½“å‰æ¨¡å‹ä¿¡æ¯
                        currentModelInfo = {
                            name: vrmModelPath,
                            path: vrmModelPath,
                            type: 'vrm'
                        };
                        
                        // åŠ è½½ VRM æ¨¡å‹ï¼ˆä¼šè‡ªåŠ¨å¾ªç¯æ’­æ”¾waitåŠ¨ä½œï¼‰
                        // æ³¨æ„ï¼švrmModelPath å¯èƒ½æ˜¯æœ¬åœ°è·¯å¾„ï¼Œéœ€è¦è½¬æ¢ä¸º URL
                        if (vrmManager) {
                            // å¦‚æœè·¯å¾„æ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œè½¬æ¢ä¸º URL
                            let modelUrl = vrmModelPath;
                            if (vrmModelPath && !vrmModelPath.startsWith('/') && !vrmModelPath.startsWith('http')) {
                                // å‡è®¾æ˜¯æ–‡ä»¶åï¼Œè½¬æ¢ä¸º URL
                                const filename = vrmModelPath.split(/[/\\]/).pop();
                                modelUrl = `/user_vrm/${filename}`;
                            } else if (vrmModelPath && vrmModelPath.includes(':')) {
                                // å¦‚æœæ˜¯ Windows è·¯å¾„ï¼ˆå¦‚ C:\...ï¼‰ï¼Œæå–æ–‡ä»¶å
                                const filename = vrmModelPath.split(/[/\\]/).pop();
                                modelUrl = `/user_vrm/${filename}`;
                            }
                            // ä¼ å…¥ { autoPlay: false }
                            await vrmManager.loadModel(modelUrl, { autoPlay: false });
                            
                            // è°ƒç”¨å·¥å…·å‡½æ•°ï¼Œè‡ªåŠ¨ä¿®æ­£æœå‘
                            fixVRMModel();
                            
                            if (vrmManager.currentVrm) {
                                autoCorrectVRMOrientation(vrmManager.currentVrm);
                            }
                            console.log('æ¨¡å‹åŠ è½½å®Œæˆï¼Œå·²é‡ç½®ä¸º T-Pose ç­‰å¾…æŒ‡ä»¤');
                            
                        } else {
                            // å¦‚æœ vrmManager è¿˜æœªåˆå§‹åŒ–ï¼Œè§¦å‘ change äº‹ä»¶æ¥åŠ è½½æ¨¡å‹
                            if (vrmModelSelect) {
                                vrmModelSelect.dispatchEvent(new Event('change'));
                            }
                        }
                        
                        showStatus(t('live2d.modelLoaded', `å·²åŠ è½½è§’è‰² ${lanlanName} çš„ VRM æ¨¡å‹`, { name: lanlanName }));
                    } else {
                        // Live2D æ¨¡å‹
                        // æ„å»ºAPI URLï¼Œæ”¯æŒå¯é€‰çš„item_idå‚æ•°
                        let apiUrl = '/api/characters/current_live2d_model';
                        const params = new URLSearchParams();

                        if (lanlanName) {
                            params.append('catgirl_name', lanlanName);
                        }

                        // å¦‚æœæœ‰item_idï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
                        const itemId = currentModelInfo ? currentModelInfo.item_id : null;
                        if (itemId) {
                            params.append('item_id', itemId);
                        }

                        // æ·»åŠ å‚æ•°åˆ°URL
                        const paramsString = params.toString();
                        if (paramsString) {
                            apiUrl += `?${paramsString}`;
                        }

                        const currentModelResponse = await fetch(apiUrl);
                        const currentModelData = await currentModelResponse.json();

                        if (!currentModelData.success) {
                            console.log('æ— æ³•è·å–å½“å‰è§’è‰²æ¨¡å‹ä¿¡æ¯:', currentModelData.error);
                            return;
                        }

                        const { catgirl_name, model_name, model_info } = currentModelData;

                        if (model_name && model_info) {
                            // å¦‚æœè§’è‰²æœ‰è®¾ç½®çš„æ¨¡å‹ï¼Œè‡ªåŠ¨åŠ è½½
                            console.log(`è‡ªåŠ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`);
                            showStatus(t('live2d.loadingCharacterModel', `æ­£åœ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}...`, { name: catgirl_name, model: model_name }));

                            // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                            currentModelInfo = model_info;
                            modelSelect.value = model_name;

                            // åŠ è½½æ¨¡å‹
                            await loadModel(model_name, model_info, model_info.item_id);

                            showStatus(t('live2d.modelLoaded', `å·²åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`, { name: catgirl_name, model: model_name }));
                        } else {
                            // å¦‚æœè§’è‰²æ²¡æœ‰è®¾ç½®æ¨¡å‹ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                            console.log(`è§’è‰² ${catgirl_name} æœªè®¾ç½®Live2Dæ¨¡å‹`);
                            showStatus(t('live2d.modelNotSet', `è§’è‰² ${catgirl_name} æœªè®¾ç½®æ¨¡å‹ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©`, { name: catgirl_name }));
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥:', error);
                    showStatus(t('live2d.loadCurrentModelFailed', 'åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥'));
                }
            }
        });

        // ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶ï¼Œç¡®ä¿è¿”å›æ—¶ä¸»ç•Œé¢å¯è§
        window.addEventListener('beforeunload', (e) => {
            // å°è¯•é€€å‡ºå…¨å±
            if (isFullscreen()) {
                try {
                    exitFullscreen();
                } catch (err) {
                    console.log('é€€å‡ºå…¨å±å¤±è´¥:', err);
                }
            }

            if (window.opener) {
                sendMessageToMainPage('show_main_ui');
            }

        });

        // ç¡®ä¿åœ¨é¡µé¢å…³é—­æ—¶ä¹Ÿæ¢å¤ä¸»ç•Œé¢
        window.addEventListener('unload', () => {
            // é¡µé¢å¸è½½æ—¶ä¸éœ€è¦å†æ¬¡å‘é€æ¶ˆæ¯
        });
    </script>

</body>

</html>